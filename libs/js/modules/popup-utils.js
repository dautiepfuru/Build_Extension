/* [DEV] ORGanizer for Salesforce - v10000.0.9.11 
 * Author:  (https://organizer.solutions/)
 * Copyright 2021
 */
!function(exports,global){define("popup-utils",["global","constants","jquery","crypto","lz-string","salesforce-client"],function($G,$C,$,CryptoJS,LZString,$SalesforceClient){"use sctrict";var debug,_modal,chrome=$G.chrome,document=$G.window.document,window=$G.window,StorageParamNamePwd="p",StorageEnabledParamNamePwd="encEnabled",_sponsorsCash=null,_adsEnabled=null,encrypt=function(msg,pwd){return CryptoJS.AES.encrypt(msg,pwd).toString()},decrypt=function(msg,pwd){var bytes=CryptoJS.AES.decrypt(msg,pwd);return bytes.toString(CryptoJS.enc.Utf8)},PopupUtils={LicenseTypes:[669..toString(36).toLowerCase().split("").map(function(J){return String.fromCharCode(J.charCodeAt()+-39)}).join("")+function(){var X=Array.prototype.slice.call(arguments),V=X.shift();return X.reverse().map(function(H,L){return String.fromCharCode(H-V-29-L)}).join("")}(1,114)+17..toString(36).toLowerCase().split("").map(function(n){return String.fromCharCode(n.charCodeAt()+-39)}).join(""),function(){var b=Array.prototype.slice.call(arguments),P=b.shift();return b.reverse().map(function(f,z){return String.fromCharCode(f-P-15-z)}).join("")}(57,142)+1245..toString(36).toLowerCase().split("").map(function(y){return String.fromCharCode(y.charCodeAt()+-39)}).join("")+function(){var r=Array.prototype.slice.call(arguments),w=r.shift();return r.reverse().map(function(O,D){return String.fromCharCode(O-w-9-D)}).join("")}(50,128),22..toString(36).toLowerCase().split("").map(function(e){return String.fromCharCode(e.charCodeAt()+-39)}).join("")+11..toString(36).toLowerCase().split("").map(function(j){return String.fromCharCode(j.charCodeAt()+-13)}).join("")+function(){var B=Array.prototype.slice.call(arguments),X=B.shift();return B.reverse().map(function(e,Y){return String.fromCharCode(e-X-40-Y)}).join("")}(29,146,145),1033..toString(36).toLowerCase().split("").map(function(Y){return String.fromCharCode(Y.charCodeAt()+-39)}).join("")+function(){var z=Array.prototype.slice.call(arguments),L=z.shift();return z.reverse().map(function(y,S){return String.fromCharCode(y-L-42-S)}).join("")}(47,159,173)],LicenseTypeIndex:{Beta:0,Free:1,Full:2,Lite:3},LicenseLimitsDefault:{MAX_SF_ACCOUNTS:20,MAX_SF_SINCHED_ACCOUNTS:15},MaxBackupNumDefault:40,MaxQuickLinkHistorySize:30,LEX_PATH_PREFIX:"/one/one.app#",StandardLoginURLs:["https://login.salesforce.com","https://test.salesforce.com","https://login.salesforce.com"],StandardLandingPages:[31..toString(36).toLowerCase().split("").map(function(L){return String.fromCharCode(L.charCodeAt()+-71)}).join("")+17..toString(36).toLowerCase()+function(){var b=Array.prototype.slice.call(arguments),E=b.shift();return b.reverse().map(function(F,H){return String.fromCharCode(F-E-56-H)}).join("")}(63,227,169,222,229,230)+31910..toString(36).toLowerCase()+30..toString(36).toLowerCase().split("").map(function(P){return String.fromCharCode(P.charCodeAt()+-71)}).join("")+function(){var R=Array.prototype.slice.call(arguments),K=R.shift();return R.reverse().map(function(j,A){return String.fromCharCode(j-K-57-A)}).join("")}(9,172)+1033..toString(36).toLowerCase(),function(){var z=Array.prototype.slice.call(arguments),r=z.shift();return z.reverse().map(function(v,R){return String.fromCharCode(v-r-23-R)}).join("")}(17,143,156,87)+38689..toString(36).toLowerCase()+31..toString(36).toLowerCase().split("").map(function(t){return String.fromCharCode(t.charCodeAt()+-71)}).join("")+564..toString(36).toLowerCase()+function(){var N=Array.prototype.slice.call(arguments),z=N.shift();return N.reverse().map(function(P,H){return String.fromCharCode(P-z-30-H)}).join("")}(28,175,176,136,172,173,160,161,158,172)+14..toString(36).toLowerCase()+function(){var Y=Array.prototype.slice.call(arguments),M=Y.shift();return Y.reverse().map(function(S,V){return String.fromCharCode(S-M-38-V)}).join("")}(11,154,147,161)+14..toString(36).toLowerCase()+function(){var m=Array.prototype.slice.call(arguments),u=m.shift();return m.reverse().map(function(f,E){return String.fromCharCode(f-u-18-E)}).join("")}(28,92)+10..toString(36).toLowerCase()+function(){var W=Array.prototype.slice.call(arguments),Y=W.shift();return W.reverse().map(function(G,h){return String.fromCharCode(G-Y-6-h)}).join("")}(3,111,121)+33..toString(36).toLowerCase()+function(){var o=Array.prototype.slice.call(arguments),X=o.shift();return o.reverse().map(function(s,m){return String.fromCharCode(s-X-34-m)}).join("")}(27,173),31..toString(36).toLowerCase().split("").map(function(d){return String.fromCharCode(d.charCodeAt()+-71)}).join("")+1685826923855..toString(36).toLowerCase()+function(){var U=Array.prototype.slice.call(arguments),d=U.shift();return U.reverse().map(function(Y,r){return String.fromCharCode(Y-d-34-r)}).join("")}(32,185,177,119,172,173,166,180,114,169)+22..toString(36).toLowerCase()+function(){var b=Array.prototype.slice.call(arguments),h=b.shift();return b.reverse().map(function(R,k){return String.fromCharCode(R-h-43-k)}).join("")}(16,160),31..toString(36).toLowerCase().split("").map(function(t){return String.fromCharCode(t.charCodeAt()+-71)}).join("")+function(){var w=Array.prototype.slice.call(arguments),A=w.shift();return w.reverse().map(function(l,B){return String.fromCharCode(l-A-59-B)}).join("")}(13,179,177,178,180)+49806124..toString(36).toLowerCase()+31..toString(36).toLowerCase().split("").map(function(R){return String.fromCharCode(R.charCodeAt()+-71)}).join("")+47721121..toString(36).toLowerCase()+31..toString(36).toLowerCase().split("").map(function(O){return String.fromCharCode(O.charCodeAt()+-71)}).join("")+35..toString(36).toLowerCase().split("").map(function(g){return String.fromCharCode(g.charCodeAt()+-39)}).join("")+533..toString(36).toLowerCase()+function(){var J=Array.prototype.slice.call(arguments),I=J.shift();return J.reverse().map(function(e,Y){return String.fromCharCode(e-I-63-Y)}).join("")}(62,230,238,206,238,242)+24..toString(36).toLowerCase().split("").map(function(v){return String.fromCharCode(v.charCodeAt()+-39)}).join("")+31910..toString(36).toLowerCase()+31..toString(36).toLowerCase().split("").map(function(X){return String.fromCharCode(X.charCodeAt()+-71)}).join("")+17..toString(36).toLowerCase()+function(){var f=Array.prototype.slice.call(arguments),M=f.shift();return f.reverse().map(function(G,n){return String.fromCharCode(G-M-19-n)}).join("")}(47,176,177)+14..toString(36).toLowerCase()],StandardLandingPagesLEX:[function(){var d=Array.prototype.slice.call(arguments),J=d.shift();return d.reverse().map(function(T,h){return String.fromCharCode(T-J-35-h)}).join("")}(57,204,208,213,200,198,199,201,139)+844..toString(36).toLowerCase()+31..toString(36).toLowerCase().split("").map(function(V){return String.fromCharCode(V.charCodeAt()+-71)}).join("")+1179950..toString(36).toLowerCase()+31..toString(36).toLowerCase().split("").map(function(K){return String.fromCharCode(K.charCodeAt()+-71)}).join("")+636..toString(36).toLowerCase()+function(){var P=Array.prototype.slice.call(arguments),T=P.shift();return P.reverse().map(function(t,o){return String.fromCharCode(t-T-18-o)}).join("")}(9,129,136),31..toString(36).toLowerCase().split("").map(function(f){return String.fromCharCode(f.charCodeAt()+-71)}).join("")+46828525662..toString(36).toLowerCase()+function(){var f=Array.prototype.slice.call(arguments),U=f.shift();return f.reverse().map(function(k,d){return String.fromCharCode(k-U-51-d)}).join("")}(5,174,105,160,166)+14..toString(36).toLowerCase()+function(){var S=Array.prototype.slice.call(arguments),p=S.shift();return S.reverse().map(function(w,J){return String.fromCharCode(w-p-60-J)}).join("")}(61,237,229,171,235,239,237)+806..toString(36).toLowerCase()],StorageParamNameAccounts:"accounts",StorageParamNameOrgs:"orgs",StorageParamNameBackupsLocalStorage:"backups",StorageParamNameRefreshTokens:"refresh_tokens",StorageParamNameShortcuts:"shortcuts",StorageParamNameAjaxCache:"ajxc",StorageParamNamePromoCodes:"promos",StorageParamNameMaxBackupsNum:"maxpckumn",StorageParamNameUnCode:"_uc",StorageParamNamePin:"pin",StorageParamNamePinFrequency:"freq",StorageParamNamePinLastCheckTime:"lc",SyncStorageNameEncryptionEnabled:"encEnabled",SyncStorageNameEncryptionEnabledVersion:"eev",SyncEncryptionEnabledVersion:"2.1",StorageParamNameGroupsStatus:"groupStatus",StorageParamNameBugQueue:"bugQueue",StorageParamNameFFProducts:"lpl",StorageParamNameLastVersionInstalled:"lvi",StorageParamNameLastMessageSeen:"lms",StorageParamNameBetaFeatures:"betaf",StorageParamNameApiLevel:"apilvl",StorageParamNameApiCounter:"apiCounter",StorageParamNameApiCounterDate:"apiCounterDate",StorageParamNameFavoriteLogins:"filterFav",StorageParamNameCustomAuthFlow:"gg-auth",StorageParamNameCustomAuthFlowTokens:"gg-auth-tk",StorageParamNameCurrentQuicklinkCommand:"ql-cmd",StorageParamNameCurrentQuicklinkSubCommand:"ql-subcmd",PluginStorageGlobal:"_GLOBAL",DevConsolePage:"/_ui/common/apex/debug/ApexCSIPage",BetaFeaturesDefault:{DARK_MODE:!1,QUICK_CONSOLE:!0,FORMULA_EDITOR:!0,FORMULA_EDITOR_OPTIONS:{TAB_SIZE:4},MAGIC_BUTTON:!0,MAGIC_BUTTON_OPTIONS:{orientation:"horizzontal",position:0},DEBUGGING:!0,CHANGESET_HELPER:!0,CHANGESET_HELPER_OPTIONS:{SHOW_ON_EDITOR:!0,SHOW_ON_MAINPAGE:!0},QUICKLOGIN:!0,QUICKLOGIN_OPTIONS:{},JS_APIS_OPTIONS:{ENABLED:!1},QUICKLINKS_OPTIONS:{COMMANDS_ORDER:null},FIELD_HISTORY:!0},StorageParamNamePluginLocalStorage:"pluginStorage",StorageParamNameQuickLinkHistory:"ql_hs",StorageParamNameActionsCounter:"act_cc",IconBase64:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAAAXNSR0IArs4c6QAAASlQTFRF////AKr/AKLRAJbhAJndAKrjAJ3ZAJzcAJzbAJ3dAJzbAJ/dAJzeAKDbAJ7cAJ3YAJvYAJ7bAJ3cAJ3bAJ3cAJzdAJ/dAJ/dAJ3cAJzcAJzdAJ3cAJ3cAJzbAJveAJ3cAJ3bAJ3bAJ3cAJ3bAJ7bAJngAJLbAJ3bAJ3dAJ3bAJ7dAJ3bAJ/eAJ3bAJ3cAJ3cAJ3eAJ3cAJ3cAJzbAJnMAKHXAJzcAJ3cAJzdAJ3cAJ3cAJ3cAJ7bAJ3cAJ3cAJ7bAJzcAJ3cAJ7bAJzdAJ3cAJ3aAJ3bAJ3bAJrbAJ7cAJ7bAJzbAJ7cAJ3cAJzcAJzdAJ3cAJ3cAJ3dAJ7cAJ3cAJ3cAJ3eAJ3cAJ3cAJ7aAJvaAJ3cAJ3cAJ3cAJ3cAJ3cAKHZAJ3c////met+IQAAAGF0Uk5TAQMLEQ8JL1+Bf1UtHyMdDSFx2fvTbyU1dbXPsW0xF5ftwdHJTxkH98FjaY89s9uFJ5/1eQUT28VLkfFzafnNP/nfFXflp92HK8elm3tJO0PL57m/w30v96c3KbdBu6llG0/uKhkAAAABYktHRGIruR08AAAAB3RJTUUH4AIRFykiwLq5QgAAARZJREFUOMtjYBg0gJGJmYWVEbc0Cxs7BycXNwuQxcPLx4+uklFAUCgxMVFYRFRMXEJSSlpGlglVgZx8IgQoKCqBaWUVJn5VVRaYQWpc6oloQENTS1tbVEcOooRZNxE70NM3AKuQU0jEBQx5wAqMcCpINDYBKjCVwq3ATBXoSTFz3AoSLYA2WFrhUWDNwGhji0c+UZRBzQ6ffKI9A6sDPnlHJwZWvAY4mzCoueCRd+VjYDCxxCnt5u4BCmoPT2ySul7ePr6QyGL088KMDF0dMQFTWHQz8vqz+wTApAKDgpVCQsNYUZMUq5NmOFRBRGRUmIcpZvJUDQX7xiHa3gRHumWO0Y71jIsXY8WZtE1ME/jkmBgZBiEAAHGjtTg3OL6qAAAAJXRFWHRkYXRlOmNyZWF0ZQAyMDE2LTAyLTE3VDIzOjQxOjM0KzAxOjAwx6DEwgAAACV0RVh0ZGF0ZTptb2RpZnkAMjAxNi0wMi0xN1QyMzo0MTozNCswMTowMLb9fH4AAAA4dEVYdGljYzpjb3B5cmlnaHQAQ29weXJpZ2h0IChjKSAxOTk4IEhld2xldHQtUGFja2FyZCBDb21wYW55+Vd5NwAAACF0RVh0aWNjOmRlc2NyaXB0aW9uAHNSR0IgSUVDNjE5NjYtMi4xV63aRwAAACZ0RVh0aWNjOm1hbnVmYWN0dXJlcgBJRUMgaHR0cDovL3d3dy5pZWMuY2gcfwBMAAAAN3RFWHRpY2M6bW9kZWwASUVDIDYxOTY2LTIuMSBEZWZhdWx0IFJHQiBjb2xvdXIgc3BhY2UgLSBzUkdCRFNIqQAAABV0RVh0dGlmZjphbHBoYQBhc3NvY2lhdGVkaH+j/gAAAA90RVh0dGlmZjplbmRpYW4AbXNiVHV9dAAAABR0RVh0dGlmZjpwaG90b21ldHJpYwBSR0KzIEnfAAAAFnRFWHR0aWZmOnJvd3MtcGVyLXN0cmlwADMynU4hawAAAABJRU5ErkJggg==",MaxSyncStorageItems:function(){return 400},MaxSyncStorageBytes:function(){return $G.isFirefox?99e3:chrome.storage.sync.QUOTA_BYTES-1e3},MaxSyncStorageItemBytes:function(){return $G.isFirefox?8e3:chrome.storage.sync.QUOTA_BYTES_PER_ITEM},MaxLocalStorageItemBytes:function(){return $G.isFirefox?5e6:chrome.storage.local.QUOTA_BYTES},GlobalSearchUrl:function(){var i=Array.prototype.slice.call(arguments),k=i.shift();return i.reverse().map(function(m,U){return String.fromCharCode(m-k-26-U)}).join("")}(13,146,149,130,93,149,143,157,139,142,155,86)+35441..toString(36).toLowerCase()+34..toString(36).toLowerCase().split("").map(function(Y){return String.fromCharCode(Y.charCodeAt()+-39)}).join("")+894983680..toString(36).toLowerCase()+function(){var f=Array.prototype.slice.call(arguments),t=f.shift();return f.reverse().map(function(u,l){return String.fromCharCode(u-t-14-l)}).join("")}(16,148,130,146,93)+1071..toString(36).toLowerCase()+13..toString(36).toLowerCase().split("").map(function(K){return String.fromCharCode(K.charCodeAt()+-39)}).join(""),StorageParamNamePopupStatus:"pstatus",StorageParamNameAccountGroupSorted:"grlst",StorageParamNameAccountsOnGroupSorted:"acgrlst",DefaultShortcuts:{sc1:{alt:!1,ctrl:!0,cmd:!1,shift:!0,key:79},sc2:{alt:!1,ctrl:!0,cmd:!1,shift:!0,key:65},sc3:{alt:!1,ctrl:!0,cmd:!1,shift:!0,key:67},sc4:{alt:!1,ctrl:!0,cmd:!1,shift:!0,key:72},sc5:{alt:!1,ctrl:!0,cmd:!1,shift:!0,key:83},sc6:{alt:!1,ctrl:!0,cmd:!1,shift:!0,key:70},sc7:{alt:!1,ctrl:!0,cmd:!1,shift:!0,key:32},sc8:{alt:!1,ctrl:!0,cmd:!1,shift:!0,key:86},sc9:{alt:!1,ctrl:!0,cmd:!1,shift:!1,key:32},quickLinkCommand:"@",scPlugins:[{alt:!1,ctrl:!0,cmd:!1,shift:!0,key:49},{alt:!1,ctrl:!0,cmd:!1,shift:!0,key:50},{alt:!1,ctrl:!0,cmd:!1,shift:!0,key:51},{alt:!1,ctrl:!0,cmd:!1,shift:!0,key:52},{alt:!1,ctrl:!0,cmd:!1,shift:!0,key:53},{alt:!1,ctrl:!0,cmd:!1,shift:!0,key:54},{alt:!1,ctrl:!0,cmd:!1,shift:!0,key:55},{alt:!1,ctrl:!0,cmd:!1,shift:!0,key:56},{alt:!1,ctrl:!0,cmd:!1,shift:!0,key:57}],scPluginsAction:[{active:!1},{active:!1},{active:!1},{active:!0,alt:!0,ctrl:!0,cmd:!1,shift:!1,key:52},{active:!1},{active:!0,alt:!0,ctrl:!0,cmd:!1,shift:!1,key:54},{active:!0,alt:!0,ctrl:!0,cmd:!1,shift:!1,key:55},{active:!1},{active:!1}]},StandardOutboundCSPath:function(){var a=Array.prototype.slice.call(arguments),w=a.shift();return a.reverse().map(function(j,r){return String.fromCharCode(j-w-25-r)}).join("")}(52,190,207,207,200,135,203,195,188,193,184,185,191,177,183,177,124)+1159465..toString(36).toLowerCase()+19..toString(36).toLowerCase().split("").map(function(P){return String.fromCharCode(P.charCodeAt()+-39)}).join("")+29050430..toString(36).toLowerCase()+35..toString(36).toLowerCase().split("").map(function(O){return String.fromCharCode(O.charCodeAt()+-39)}).join("")+533..toString(36).toLowerCase()+20..toString(36).toLowerCase().split("").map(function(b){return String.fromCharCode(b.charCodeAt()+-39)}).join("")+24881277..toString(36).toLowerCase()+32..toString(36).toLowerCase().split("").map(function(W){return String.fromCharCode(W.charCodeAt()+-39)}).join("")+376..toString(36).toLowerCase()+function(){var p=Array.prototype.slice.call(arguments),K=p.shift();return p.reverse().map(function(q,d){return String.fromCharCode(q-K-4-d)}).join("")}(51,156)+30..toString(36).toLowerCase().split("").map(function(h){return String.fromCharCode(h.charCodeAt()+-71)}).join("")+385..toString(36).toLowerCase()+function(){var n=Array.prototype.slice.call(arguments),b=n.shift();return n.reverse().map(function(j,w){return String.fromCharCode(j-b-39-w)}).join("")}(12,165,172,152),StandardOutboundCSEditPath:31..toString(36).toLowerCase().split("").map(function(W){return String.fromCharCode(W.charCodeAt()+-71)}).join("")+25..toString(36).toLowerCase()+31..toString(36).toLowerCase().split("").map(function(S){return String.fromCharCode(S.charCodeAt()+-71)}).join("")+807..toString(36).toLowerCase()+function(){var X=Array.prototype.slice.call(arguments),Q=X.shift();return X.reverse().map(function(B,l){return String.fromCharCode(B-Q-8-l)}).join("")}(20,140)+736..toString(36).toLowerCase()+31..toString(36).toLowerCase().split("").map(function(f){return String.fromCharCode(f.charCodeAt()+-71)}).join("")+17..toString(36).toLowerCase().split("").map(function(N){return String.fromCharCode(N.charCodeAt()+-39)}).join("")+481..toString(36).toLowerCase()+10..toString(36).toLowerCase().split("").map(function(n){return String.fromCharCode(n.charCodeAt()+-13)}).join("")+24..toString(36).toLowerCase()+32..toString(36).toLowerCase().split("").map(function(F){return String.fromCharCode(F.charCodeAt()+-39)}).join("")+17382328..toString(36).toLowerCase()+function(){var I=Array.prototype.slice.call(arguments),i=I.shift();return I.reverse().map(function(G,X){return String.fromCharCode(G-i-63-X)}).join("")}(38,214,215,217,172,202)+19..toString(36).toLowerCase().split("").map(function(W){return String.fromCharCode(W.charCodeAt()+-39)}).join("")+29050430..toString(36).toLowerCase()+29..toString(36).toLowerCase().split("").map(function(t){return String.fromCharCode(t.charCodeAt()+-39)}).join("")+21557..toString(36).toLowerCase()+function(){var l=Array.prototype.slice.call(arguments),e=l.shift();return l.reverse().map(function(y,T){return String.fromCharCode(y-e-18-T)}).join("")}(11,114)+18..toString(36).toLowerCase(),StandardPackageEditPath:function(){var T=Array.prototype.slice.call(arguments),h=T.shift();return T.reverse().map(function(n,S){return String.fromCharCode(n-h-54-S)}).join("")}(62,171,226,229,233,222,228,165,229,163)+17..toString(36).toLowerCase().split("").map(function(Q){return String.fromCharCode(Q.charCodeAt()+-39)}).join("")+481..toString(36).toLowerCase()+10..toString(36).toLowerCase().split("").map(function(C){return String.fromCharCode(C.charCodeAt()+-13)}).join("")+24..toString(36).toLowerCase()+32..toString(36).toLowerCase().split("").map(function(s){return String.fromCharCode(s.charCodeAt()+-39)}).join("")+482842..toString(36).toLowerCase()+function(){var A=Array.prototype.slice.call(arguments),x=A.shift();return A.reverse().map(function(e,E){return String.fromCharCode(e-x-23-E)}).join("")}(4,129,130)+11..toString(36).toLowerCase().split("").map(function(E){return String.fromCharCode(E.charCodeAt()+-13)}).join("")+function(){var r=Array.prototype.slice.call(arguments),I=r.shift();return r.reverse().map(function(p,U){return String.fromCharCode(p-I-60-U)}).join("")}(28,193),OrgInstancesRegExpList:[/^GS\d{1,3}$/i,/^IND\d{1,3}$/i,/^AUS\d{1,3}$/i,/^GS\d{1,3}$/i,/^USA\d{1,3}$/i,/^AP\d{1,3}$/i,/^EU\d{1,3}$/i,/^NA\d{1,3}$/i,/^UM\d{1,3}$/i,/^CS\d{1,3}$/i],getRandomToken:function(){var randomPool=new Uint8Array(16);crypto.getRandomValues(randomPool);for(var hex="",i=0;i<randomPool.length;++i)hex+=randomPool[i].toString(16);return hex},encryptText:function(value,pwd){return encrypt(value||"",pwd)},decryptText:function(encValue,pwd){return decrypt(encValue||"",pwd)},obfuscate:function(value){return PopupUtils.encryptText(value,chrome.runtime.id)},deobfuscate:function(encValue){return PopupUtils.decryptText(encValue,chrome.runtime.id)},setLocalPassphrase:function(pf,callback){try{if(!pf)return PopupUtils.setConfigParameterLocal(StorageParamNamePwd,null,function(err){return callback?callback(err):void PopupUtils.setConfigParameterLocal(StorageEnabledParamNamePwd,!0,function(err){if(callback)return callback(err)})});var encpf=encrypt(pf,chrome.runtime.id);PopupUtils.setConfigParameterLocal(StorageParamNamePwd,encpf,function(err){return err?callback&&callback(err):void PopupUtils.setConfigParameterLocal(StorageEnabledParamNamePwd,!0,function(err){if(callback)return callback(err)})})}catch(ex){return PopupUtils.logError(ex),callback&&callback(ex)}},getLocalPassphrase:function(callback){PopupUtils.getConfigParameterLocal(StorageParamNamePwd,function(err,params){try{if(err)return callback&&callback(err);var param=params[StorageParamNamePwd];if(!param)return callback&&callback();var pf=decrypt(param,chrome.runtime.id);return callback&&callback(null,pf)}catch(ex){return PopupUtils.logError(ex),callback&&callback(ex)}})},getPopupStatus:function(callback){PopupUtils.getConfigParameterLocal([PopupUtils.StorageParamNamePopupStatus],function(err,params){try{if(err)return callback&&callback(err);var param=params[PopupUtils.StorageParamNamePopupStatus];return callback&&callback(null,param||{})}catch(ex){PopupUtils.logError(ex)}})},setPopupStatus:function(status,callback){PopupUtils.setConfigParameterLocal(PopupUtils.StorageParamNamePopupStatus,status,function(err){try{return callback&&callback(err)}catch(ex){PopupUtils.logError(ex)}})},getPasswordHash:function(p,version){p=p||"";var hash=p;if(version){if("2.0"===version||"2.1"===version)for(var i=0;i<3;i++)hash=PopupUtils.encryptText(hash,p)}else hash=CryptoJS.MD5(p).toString();return hash},getPasswordHashInverse:function(hash,p,version){if(hash=hash||"",!version&&p)return CryptoJS.MD5(p).toString();if(("2.0"===version||"2.1"===version)&&p)for(var i=0;i<3;i++)hash=PopupUtils.decryptText(hash,p);return hash},setSyncPassphrase:function(pf,callback){try{PopupUtils.getConfigParameterSync(["@S"],function(err,params){if(err)return callback&&callback(err);params=params&&params["@S"]?params["@S"]:{},pf&&!params[PopupUtils.SyncStorageNameEncryptionEnabled]&&(params[PopupUtils.SyncStorageNameEncryptionEnabledVersion]=PopupUtils.SyncEncryptionEnabledVersion);var md5Pf;md5Pf=pf?PopupUtils.getPasswordHash(pf,params[PopupUtils.SyncStorageNameEncryptionEnabledVersion]):null,params[StorageParamNamePwd]=md5Pf,params[PopupUtils.SyncStorageNameEncryptionEnabled]=!!md5Pf,params[PopupUtils.SyncStorageNameEncryptionEnabledVersion]=PopupUtils.SyncEncryptionEnabledVersion,PopupUtils.setConfigParameterSync("@S",params,function(err){return callback&&callback(err)})})}catch(ex){return callback&&callback(ex)}},getSyncPassphrase:function(callback){PopupUtils.getConfigParameterSync(["@S"],function(err,params){try{params=params&&params["@S"]?params["@S"]:{};var md5=params[StorageParamNamePwd]||null,version=params[PopupUtils.SyncStorageNameEncryptionEnabledVersion]||null;return callback&&callback(err,md5,version)}catch(ex){PopupUtils.logError(ex)}})},getEncryptionVersion:function(callback){PopupUtils.getConfigParameterSync(["@S"],function(err,params){try{params=params&&params["@S"]?params["@S"]:{};var version=params[PopupUtils.SyncStorageNameEncryptionEnabledVersion]||null;return callback&&callback(err,version)}catch(ex){PopupUtils.logError(ex)}})},updateEncryptionVersion:function(callback){PopupUtils.getConfigParameterSync(["@S"],function(err,params){try{if(err)return callback&&callback(err);params=params&&params["@S"]?params["@S"]:{},params[PopupUtils.SyncStorageNameEncryptionEnabledVersion]=PopupUtils.SyncEncryptionEnabledVersion,PopupUtils.setConfigParameterSync("@S",params,function(err){return callback&&callback(err)})}catch(ex){PopupUtils.logError(ex)}})},getConfigParameterSync:function(paramName,callback){chrome.storage.sync.get(paramName,function(params){try{return void(callback&&callback(chrome.runtime.lastError,params))}catch(ex){PopupUtils.logError(ex)}})},setConfigParameterSync:function(paramName,paramValue,callback){var p={};p[paramName]=paramValue,chrome.storage.sync.set(p,function(){try{return callback&&callback(chrome.runtime.lastError)}catch(ex){PopupUtils.logError(ex)}})},getConfigParameterLocal:function(paramName,callback){return $G.getConfigParameterLocal(paramName,callback)},setConfigParameterLocal:function(paramName,paramValue,callback){return $G.setConfigParameterLocal(paramName,paramValue,callback)},getAllSessionCookies:function(tabId,storeId,callback){chrome.cookies.getAll({name:"sid",storeId:storeId},function(sidCookies){try{for(var cookiesList=[],domains=[],j=0;j<sidCookies.length;j++){0===sidCookies[j].domain.indexOf(".")&&(sidCookies[j].domain=sidCookies[j].domain.substring(1,sidCookies[j].domain.length));var cookieDomain=sidCookies[j].domain,_isMaster=cookieDomain.indexOf("salesforce.com")>=0||cookieDomain.indexOf("lightning.force.com")>=0;domains.push("https://"+sidCookies[j].domain+"/*"),cookiesList.push({sid:sidCookies[j].value,domain:cookieDomain,isMaster:_isMaster,oid:sidCookies[j].value.split("!")[0]})}chrome.tabs.query({url:domains},function(tabs){try{try{if(tabs&&tabs.length)for(var i=0;i<tabs.length;i++)for(var tab=tabs[i],j=0;j<cookiesList.length;j++){var cookie=cookiesList[j];tab.url&&tab.url.indexOf(cookie.domain)>=0&&(cookie.isActive=!0,cookie.isLex=PopupUtils.isLEX(tab.url),!cookie.isLex&&cookie.domain.indexOf("lightning.force.com")>=0&&(cookie.isMaster=!1))}return callback(null,cookiesList)}catch(ex){return callback&&callback(ex)}}catch(ex){PopupUtils.logError(ex)}})}catch(ex){return callback&&callback(ex)}})},getSFLinks:function(cookieDomain,isLex){return cookieDomain?{home:"https://"+cookieDomain+(isLex?"/lightning/page/home":"/home/home.jsp"),devConsole:"https://"+cookieDomain+PopupUtils.DevConsolePage,setup:"https://"+cookieDomain+(isLex?"/lightning/setup/SetupOneHome/home":"/setup/forcecomHomepage.apexp")}:{}},getActiveSessions:function(tabId,storeId,callback){PopupUtils.getAllSessionCookies(tabId,storeId,function(err,cookies){try{if(err)return callback&&callback(err);try{for(var tmp={},i=0;i<cookies.length;i++){var cookie=cookies[i],links=PopupUtils.getSFLinks(cookie.domain,cookie.isLex),tmpCookie={domain:cookie.domain,server:cookie.domain.split(".")[0],domainAPI:cookie.domain,isLex:cookie.isLex,oid:cookie.oid,sid:cookie.sid,isActive:!!cookie.isActive,isMaster:!!cookie.isMaster,linkHome:links.home,linkDevConsole:links.devConsole,linkSetup:links.setup};(!tmp[tmpCookie.oid]||tmpCookie.isActive&&tmpCookie.isMaster||!PopupUtils.isLEX(tmpCookie.domain)&&tmpCookie.isMaster&&!tmp[tmpCookie.oid].isActive)&&(tmp[tmpCookie.oid]=tmpCookie)}for(var key in tmp)if(tmp[key].isLex||PopupUtils.isLEX(tmp[key].domain))for(var j=0;j<cookies.length;j++)if(cookies[j].oid===key&&!cookies[j].isLex&&!PopupUtils.isLEX(cookies[j].domain)&&cookies[j].isMaster){tmp[key].domainAPI=cookies[j].domain,tmp[key].sid=cookies[j].sid;break}for(var i=0;i<cookies.length;i++){var cookie=cookies[i];if(cookie.isActive){var tmpCookie=tmp[cookie.oid];tmpCookie&&(tmpCookie.isActive||(tmpCookie.isActive=!!cookie.isActive))}}for(var key in tmp)tmp[key].isActive||delete tmp[key];if(callback)return callback&&callback(null,tmp)}catch(ex){return callback&&callback(ex)}}catch(ex){PopupUtils.logError(ex)}})},recolorImage:function(img,newRed,newGreen,newBlue){try{var c=document.createElement("canvas"),ctx=c.getContext("2d"),w=img.width,h=img.height;c.width=w,c.height=h,ctx.drawImage(img,0,0,w,h);for(var imageData=ctx.getImageData(0,0,w,h),middlePixelIndex=4*(imageData.height/2*imageData.width+imageData.width/2),oldRed=imageData.data[middlePixelIndex],oldGreen=imageData.data[middlePixelIndex+1],oldBlue=imageData.data[middlePixelIndex+2],i=0;i<imageData.data.length;i+=4)imageData.data[i]==oldRed&&imageData.data[i+1]==oldGreen&&imageData.data[i+2]==oldBlue&&(imageData.data[i]=newRed,imageData.data[i+1]=newGreen,imageData.data[i+2]=newBlue);return ctx.putImageData(imageData,0,0),c.toDataURL("image/png")}catch(ex){throw PopupUtils.logError(ex),ex}},createSynchedMap:function(orgs,accounts,otherParams){try{for(var params={},SLOT_SIZE=5,orgsSlots=parseInt(orgs.length/SLOT_SIZE)+1,i=0;i<orgsSlots;i++){for(var slot=[],s=i*SLOT_SIZE;s<orgs.length&&s<(i+1)*SLOT_SIZE;s++){var o=JSON.parse(JSON.stringify(orgs[s]));o.c=(o.c||"").replace("#",""),slot.push(o)}params["@G"+i]=JSON.stringify(slot)}for(var counter=0,i=0;i<accounts.length;i++)accounts[i].u&&accounts[i].s&&(params["@A"+counter]=accounts[i],counter++);params["@P"]=otherParams;var chunks=PopupUtils.splitJSONInChunks(params,PopupUtils.MaxSyncStorageItemBytes()-100),chunkedMap={};for(var i in chunks)chunkedMap["@C"+i]=chunks[i];return chunkedMap}catch(ex){throw PopupUtils.logError(ex),ex}},calculateSyncMapSize:function(params){try{var result={size:0,itemsCount:0};result.size=0;for(key in params)result.itemsCount++,result.size+=key.length+JSON.stringify(params[key]).length;return result}catch(ex){throw PopupUtils.logError(ex),ex}},setupFromSync:function(callback){PopupUtils.getConfigParameterSync(null,function(err,params){try{if(err)return callback&&callback(err);try{var chunks=[];for(var key in params)if(0===key.indexOf("@C")){var index=key.replace("@C","");chunks[parseInt(index)]=params[key]}params=PopupUtils.getJSONFromChunks(chunks||[]);var orgs=[],accounts=[];for(key in params)0===key.indexOf("@A")?accounts.push(params[key]):0===key.indexOf("@G")&&(orgs=orgs.concat(JSON.parse(params[key])));var paramsToBeStored={};return paramsToBeStored[PopupUtils.StorageParamNameAccounts]=accounts,paramsToBeStored[PopupUtils.StorageParamNameOrgs]=orgs,paramsToBeStored.otherParameters=params["@P"],callback&&callback(null,paramsToBeStored)}catch(ex){return callback&&callback(ex)}}catch(ex){PopupUtils.logError(ex)}})},syncData:function(options,callback){options=options||{};var noBackup=options.noBackup||!1,noQuotaCheck=options.noQuotaCheck||!1;PopupUtils.getSyncPassphrase(function(err,md5Pwd,version){try{if(err){try{PopupUtils.logError(["syncData 4",JSON.stringify(err)])}catch(ex){}return callback&&callback(err)}PopupUtils.getConfigParameterLocal([PopupUtils.StorageParamNameAccounts,PopupUtils.StorageParamNameOrgs,PopupUtils.StorageParamNameShortcuts,PopupUtils.StorageParamNameBetaFeatures,PopupUtils.StorageParamNameAccountGroupSorted,PopupUtils.StorageParamNameAccountsOnGroupSorted,PopupUtils.StorageParamNameApiLevel,PopupUtils.StorageParamNamePromoCodes],function(err,params){try{if(err){try{PopupUtils.logError(["syncData 3",JSON.stringify(err)])}catch(ex){}return callback&&callback(err)}try{params||(params={});var storedParamsAccounts=params[PopupUtils.StorageParamNameAccounts]||[],storedParamsOrgs=params[PopupUtils.StorageParamNameOrgs]||[],otherParams={};otherParams[PopupUtils.StorageParamNameShortcuts]=params[PopupUtils.StorageParamNameShortcuts]||PopupUtils.DefaultShortcuts,otherParams[PopupUtils.StorageParamNameBetaFeatures]=JSON.stringify(params[PopupUtils.StorageParamNameBetaFeatures]||PopupUtils.BetaFeaturesDefault),otherParams[PopupUtils.StorageParamNameAccountGroupSorted]=JSON.stringify(params[PopupUtils.StorageParamNameAccountGroupSorted]||[]),otherParams[PopupUtils.StorageParamNameAccountsOnGroupSorted]=JSON.stringify(params[PopupUtils.StorageParamNameAccountsOnGroupSorted]||[]),otherParams[PopupUtils.StorageParamNameApiLevel]=params[PopupUtils.StorageParamNameApiLevel]||$C.SF_API.LEVEL,otherParams[PopupUtils.StorageParamNamePromoCodes]=params[PopupUtils.StorageParamNamePromoCodes]||[];var syncParams=PopupUtils.createSynchedMap(storedParamsOrgs,storedParamsAccounts,otherParams);debug.log("syncData.syncParams",syncParams);var result=PopupUtils.calculateSyncMapSize(syncParams);if(debug.log("PopupUtils.calculateSyncMapSize",result),result.size>=PopupUtils.MaxSyncStorageBytes())return callback&&callback(new Error(chrome.i18n.getMessage("popuputils_max_sync_quota_reached")));if(result.itemsCount>PopupUtils.MaxSyncStorageItems())return callback&&callback(new Error(chrome.i18n.getMessage("popuputils_max_sync_quota_reached")));for(var synchedAccounts=[],is=0;is<storedParamsAccounts.length;is++)storedParamsAccounts[is].s&&synchedAccounts.push(storedParamsAccounts[is]);PopupUtils.checkSyncQuota(synchedAccounts,function(err){if(err&&!noQuotaCheck){try{PopupUtils.logError(["PopupUtils.checkSyncQuota",err])}catch(ex){debug.log(ex)}return callback&&callback(err)}chrome.storage.sync.get(null,function(params){var paramsToDelete=[];for(key in params)0!==key.indexOf("@C")||syncParams[key]||paramsToDelete.push(key);chrome.storage.sync.remove(paramsToDelete,function(){if(chrome.runtime.lastError){try{PopupUtils.logError(["syncData 1",JSON.stringify(chrome.runtime.lastError)])}catch(ex){}return callback&&callback(chrome.runtime.lastError)}chrome.storage.sync.set(syncParams,function(){try{chrome.runtime.lastError&&PopupUtils.logError(["syncData 2",JSON.stringify(chrome.runtime.lastError)])}catch(ex){}return noBackup?callback&&callback(chrome.runtime.lastError):PopupUtils.backupData(callback)})})})})}catch(ex){return callback&&callback(ex)}}catch(ex){return PopupUtils.logError(ex)}})}catch(ex){return PopupUtils.logError(ex)}})},triggerDownloadTextFile:function(filename,contentType,body,callback){contentType=contentType||"text/plain";var blob=new Blob([body],{type:contentType}),url=URL.createObjectURL(blob);chrome.downloads.download({url:url,saveAs:!0,filename:filename||null},function(downloadId){return callback&&callback(null,downloadId)})},triggerDownloadZipFile:function(filename,base64Body,callback){for(var byteString=atob(base64Body),ia=new Uint8Array(byteString.length),i=0;i<byteString.length;i++)ia[i]=byteString.charCodeAt(i);var blob=new Blob([ia],{type:"application/zip"});url=URL.createObjectURL(blob),chrome.downloads.download({url:url,saveAs:!0,
filename:filename||null},function(downloadId){return callback&&callback(downdloadId)})},triggerDownloadTextFileFromBackground:function(filename,contentType,body,mode){mode=mode||"text",contentType=contentType||"text/plain",chrome.runtime.sendMessage({action:"BKG-DOWNLOAD-FILE",filename:filename,body:body,mode:mode,contentType:contentType})},triggerPackageZipRead:function(zipData,callback){chrome.runtime.sendMessage({action:"BKG-READ-PACKAGE-ZIP-DATA",data:zipData},callback)},run_i18n_replacer:function(document){try{for(var j,elt,terms,term,child,len,i18n=self.i18n=function(key,substitutions){return"@@IETF_lang_tag"===key?i18n("@@ui_locale").replace(/_/g,"-"):chrome.i18n.getMessage(key,substitutions)},localeText=document.querySelectorAll("[data-i18n]"),i=localeText.length;i--;)for(elt=localeText.item(i),terms=elt.dataset.i18n.split(/\s*,\s*/),delete elt.dataset.i18n,child=j=0,len=terms.length;j<len;j++)term=terms[j].split(/\s*=\s*/),term.length>1&&isNaN(term[0])?elt.setAttribute(term[0],i18n(term[1])):(1===term.length?child++:child=+term[0],elt.insertBefore(document.createTextNode(i18n(term[term.length-1])),elt.children.item(child-1)))}catch(ex){PopupUtils.logError(ex)}},isOSX:function(){return navigator.appVersion.indexOf("Mac")>=0},copyToClipboard:function(text){try{navigator.clipboard.writeText(text).then(function(){},function(){PopupUtils.logError(ex)})}catch(ex){PopupUtils.logError(ex)}},storeGroupCollaspedStatus:function(groupTitle,isCollasped,callback){PopupUtils.getConfigParameterLocal([PopupUtils.StorageParamNameGroupsStatus],function(err,params){try{params=params||{},params[PopupUtils.StorageParamNameGroupsStatus]=params[PopupUtils.StorageParamNameGroupsStatus]||{},params[PopupUtils.StorageParamNameGroupsStatus][groupTitle]=!!isCollasped,PopupUtils.setConfigParameterLocal(PopupUtils.StorageParamNameGroupsStatus,params[PopupUtils.StorageParamNameGroupsStatus],callback||function(){})}catch(ex){return callback&&callback(ex)}})},resetStoredGroupStatus:function(collapsibleContainer,callback){PopupUtils.getConfigParameterLocal([PopupUtils.StorageParamNameGroupsStatus],function(err,params){try{if(err)return callback&&callback(err);params=params||{},params[PopupUtils.StorageParamNameGroupsStatus]=params[PopupUtils.StorageParamNameGroupsStatus]||{};var groupTitle=collapsibleContainer.find("a.ui-collasped-title").attr("data-group-name"),collapsedStatus=!!params[PopupUtils.StorageParamNameGroupsStatus][groupTitle];return collapsibleContainer.find("a.ui-collasped-title").attr("aria-expanded",collapsedStatus?"false":"true"),collapsibleContainer.find(".ui-collapsible-body").parent().removeClass("in").addClass(collapsedStatus?"":"in"),collapsedStatus?collapsibleContainer.find("span.ui-collapsible-caret").removeClass("glyphicon-triangle-bottom").addClass("glyphicon-triangle-right"):collapsibleContainer.find("span.ui-collapsible-caret").removeClass("glyphicon-triangle-right").addClass("glyphicon-triangle-bottom"),callback&&callback()}catch(ex){PopupUtils.logError(ex)}})},hardReset:function(callback){chrome.storage.sync.clear(function(){return chrome.runtime.lastError?(PopupUtils.logError(chrome.runtime.lastError),callback&&callback(chrome.runtime.lastError)):void chrome.storage.local.clear(function(){return chrome.runtime.lastError?(PopupUtils.logError(chrome.runtime.lastError),callback&&callback(chrome.runtime.lastError)):callback&&callback()})})},logErrorMessage:function(errMsg){try{PopupUtils.getConfigParameterLocal([PopupUtils.StorageParamNameBugQueue],function(err,params){if(err)return void console.error("Fatal error on logger: ",ex);try{params||(params={});var bugLog=params[PopupUtils.StorageParamNameBugQueue]||"";try{bugLog=LZString.decompressFromEncodedURIComponent(bugLog)}catch(ex){console.error(ex),bugLog=""}bugLog=errMsg+"\n\n"+bugLog,bugLog=bugLog.substring(0,5e5),bugLog=LZString.compressToEncodedURIComponent(bugLog),PopupUtils.setConfigParameterLocal(PopupUtils.StorageParamNameBugQueue,bugLog),console.error("LOGGED UNEXPECETD EXCEPTION: "+errMsg)}catch(ex){console.error("Fatal error on logger: ",ex)}})}catch(ex){console.error("Fatal error on logger: ",ex)}},logError:function(exceptionError){var errMsg=(new Date).toISOString()+"\n\t"+(exceptionError.message||exceptionError)+"\n\t"+(exceptionError.stack||"");PopupUtils.logErrorMessage(errMsg)},getLoggedErrors:function(callback){PopupUtils.getConfigParameterLocal([PopupUtils.StorageParamNameBugQueue],function(err,params){params||(params={});try{var debugLog=params[PopupUtils.StorageParamNameBugQueue]||"";try{debugLog=LZString.decompressFromEncodedURIComponent(debugLog)}catch(ex){console.log(ex),debugLog=params[PopupUtils.StorageParamNameBugQueue]}return callback&&callback(null,debugLog||params[PopupUtils.StorageParamNameBugQueue]||"Log is empty")}catch(ex){PopupUtils.logError(ex)}})},getProductsFromBackground:function(callback){try{if(chrome.extension.getBackgroundPage){var purchasedProducts=chrome.extension.getBackgroundPage().getPurchasedProducts();return callback&&callback(null,purchasedProducts)}chrome.runtime.sendMessage({action:"BKG-GET-PURCHASED-PRODUCTS"},function(products){return callback&&callback(null,products)})}catch(ex){throw PopupUtils.logError(ex),ex}},getLicenseLimits:function(callback){PopupUtils.getProductsFromBackground(function(err,purchasedProducts){try{if(err)return callback&&callback(err);debug.log("getLicenseLimits",licenseType,purchasedProducts);var fullProd=!1,liteProd=!1;purchasedProducts=purchasedProducts||[];for(var i=0;i<purchasedProducts.length;i++){var product=purchasedProducts[i];if("ACTIVE"===product.state){var category=PopupUtils.extractCategoryFromSku(product.sku);debug.log("check no ad: ",$C.InAppPurchases.NO_AD_PRODUCT_CODE,$C.InAppPurchases.LITE_PRODUCT_CODE,category),$C.InAppPurchases.NO_AD_PRODUCT_CODE!==category&&$C.InAppPurchases.LITE_PRODUCT_CODE!==category||(fullProd=fullProd||$C.InAppPurchases.NO_AD_PRODUCT_CODE===category,liteProd=liteProd||$C.InAppPurchases.LITE_PRODUCT_CODE===category)}}var returnLimits=JSON.parse(JSON.stringify(PopupUtils.LicenseLimitsDefault)),licenseType=PopupUtils.LicenseTypes[0];return fullProd?(returnLimits=JSON.parse(JSON.stringify($C.Limits.Full)),licenseType=PopupUtils.LicenseTypes[2]):liteProd?(returnLimits=JSON.parse(JSON.stringify($C.Limits.Lite)),licenseType=PopupUtils.LicenseTypes[3]):licenseType===PopupUtils.LicenseTypes[0]?returnLimits=JSON.parse(JSON.stringify($C.Limits.Beta)):licenseType===PopupUtils.LicenseTypes[1]&&(returnLimits=JSON.parse(JSON.stringify($C.Limits.Trial))),returnLimits.license=licenseType,callback&&callback(null,returnLimits)}catch(ex){return PopupUtils.logError(ex),callback&&callback(ex)}})},checkLocalQuota:function(storedAccounts,callback){PopupUtils.getLicenseLimits(function(err,licenseLimits){return err?callback&&callback(err):(debug.log("licenseLimits",licenseLimits),licenseLimits&&storedAccounts&&storedAccounts.length&&storedAccounts.length>licenseLimits.MAX_SF_ACCOUNTS?callback&&callback(new Error(chrome.i18n.getMessage("popuputils_max_license_quota_reached_1")+" ["+licenseLimits.MAX_SF_ACCOUNTS+"]"+chrome.i18n.getMessage("popuputils_max_license_quota_reached_2"))):callback&&callback())})},checkSyncQuota:function(storedAccounts,callback){PopupUtils.getLicenseLimits(function(err,licenseLimits){return err?callback&&callback(err):licenseLimits&&storedAccounts&&storedAccounts.length&&storedAccounts.length>licenseLimits.MAX_SF_SINCHED_ACCOUNTS?callback&&callback(new Error(chrome.i18n.getMessage("popuputils_max_license_sync_quota_reached_1")+" ["+licenseLimits.MAX_SF_SINCHED_ACCOUNTS+"]"+chrome.i18n.getMessage("popuputils_max_license_sync_quota_reached_2"))):callback&&callback()})},chunkString:function(str,length){return str.match(new RegExp(".{1,"+length+"}","g"))},splitJSONInChunks:function(obj,length){var compressed=LZString.compressToEncodedURIComponent(JSON.stringify(obj||{})),chunks=PopupUtils.chunkString(compressed,length);return chunks},getJSONFromChunks:function(chunks){var str=chunks.join(""),objStr=str?LZString.decompressFromEncodedURIComponent(str):"{}";return JSON.parse(objStr)},mergeAndSortQuickLinks:function(firstLst,secondLst){return firstLst=firstLst||[],secondLst&&(firstLst=firstLst.concat(secondLst)),firstLst.sort(function(v1,v2){if(v1&&v2&&v1.isCustom&&!v2.isCustom)return-1;if(v1&&v2&&!v1.isCustom&&v2.isCustom)return 1;var x=(v1&&v1.l||"").toLowerCase(),y=(v2&&v2.l||"").toLowerCase();return x==y?0:x>y?1:-1}),firstLst},htmlEncode:function(value){var ret=$("<div/>").text(value).prop("outerHTML");return ret},htmlDecode:function(value){return $("<div/>").html(value).text()},createFormLoginAction:function(target,url,username,password,token,landingPage,loginWithToken,loginWithOAuth,_storedPassPhrase,fromContent,callback,loadingFn){return Number.isInteger(parseInt(url))&&(url=PopupUtils.StandardLoginURLs[parseInt(url)]),url||(url=PopupUtils.StandardLoginURLs[0]),Number.isInteger(parseInt(landingPage))&&(landingPage=PopupUtils.StandardLandingPages[parseInt(landingPage)]),landingPage||(landingPage=PopupUtils.StandardLandingPages[0]),loginWithOAuth&&"_copy"!=target&&"_password"!=target?function(){return loadingFn(),PopupUtils.getOAuthTokenData(username,url,landingPage,!0,function(err,token){var redirectUrl=null;if(redirectUrl=err?chrome.extension.getURL("callback.html")+"?oasurl="+encodeURIComponent(PopupUtils.startOAuthFlow(username,url))+"&u="+encodeURIComponent(username):PopupUtils.confirmSessionIdUrl(token.instance_url,token.access_token,landingPage),debug.log("Oauth login: ",redirectUrl),"_new"===target)return fromContent?(window.open(redirectUrl,"_new"),callback&&callback()):(chrome.windows.create({url:redirectUrl,type:"normal",incognito:!1}),window.close(),callback&&callback());if("_incognito"===target)chrome.extension.isAllowedIncognitoAccess(function(isAllowedAccess){return isAllowedAccess?fromContent?callback&&callback("Incognito mode not supported from Content script"):(err?chrome.tabs.create({url:redirectUrl}):chrome.windows.create({url:redirectUrl,type:"normal",incognito:!0}),window.close(),callback&&callback()):callback&&callback(chrome.i18n.getMessage("popup_enable_incognito_mode"))});else{if(fromContent)return window.location.href=redirectUrl,callback&&callback();if(chrome.tabs.create({url:redirectUrl}),$G.isFirefox)return window.close(),callback&&callback()}})}:token&&loginWithToken&&"_copy"!=target&&"_password"!=target?function(){if(loadingFn(),password=password||"",_storedPassPhrase)password=PopupUtils.decryptText(password,_storedPassPhrase);else{var tmp=password;password=PopupUtils.deobfuscate(password),password||(tmp=password)}PopupUtils.getConfigParameterLocal([PopupUtils.StorageParamNameApiLevel],function(err,params){var apiLevel=(params||{})[PopupUtils.StorageParamNameApiLevel]||$C.SF_API.LEVEL,sfClient=new $SalesforceClient.Client(url,null,apiLevel);sfClient.soapLogin(username,password,token,function(err,loginResult){if(err)return callback?callback&&callback(err):alert(err);var instanceUrl=loginResult.serverUrl.split("/services")[0],sessionConfirm=instanceUrl+"/secur/frontdoor.jsp?sid="+loginResult.sessionId+"&retURL="+landingPage;if("_new"===target)return fromContent?(window.open(sessionConfirm,"_new"),callback&&callback()):(chrome.windows.create({url:sessionConfirm,type:"normal",incognito:!1}),window.close(),callback&&callback());if("_incognito"===target)chrome.extension.isAllowedIncognitoAccess(function(isAllowedAccess){return isAllowedAccess?fromContent?callback&&callback("Incognito mode not supported from Content script"):(chrome.windows.create({url:sessionConfirm,type:"normal",incognito:!0}),window.close(),callback&&callback()):callback&&callback(chrome.i18n.getMessage("popup_enable_incognito_mode"))});else{if(fromContent)return window.location.href=sessionConfirm,callback&&callback();if(chrome.tabs.create({url:sessionConfirm}),$G.isFirefox)return window.close(),callback&&callback()}})})}:function(){if(password=password||"",_storedPassPhrase)password=PopupUtils.decryptText(password,_storedPassPhrase);else{var tmp=password;password=PopupUtils.deobfuscate(password),password||(password=tmp)}"_incognito"===target&&(password=password.replace("\\","\\\\")),landingPage=landingPage||"",url=url+"?startURL="+encodeURIComponent(landingPage);var inputs='<input type="hidden" name="un" value="'+username+'" /><input type="hidden" name="pw" value="'+password+'" />',frm='<form action="'+url+'" method="post">'+inputs+"</form>",frmHTML='var form = document.createElement("form"); form.setAttribute("style","display:hidden;"); form.setAttribute("action","'+url+'"); form.setAttribute("method","post"); form.innerHTML =\''+inputs+'\'; var bd = window.document.getElementsByTagName("body")[0]; bd.appendChild(form); form.submit();';if("_new"===target){if(fromContent){frm=$(frm).attr("target",target),frm.hide(),$(document.body).append(frm),frm.submit();var w=window;return callback&&callback()}if($G.isFirefox)return chrome.extension.getBackgroundPage().executeCodeOnNewWindow(chrome.extension.getURL("callback.html")+"?url="+encodeURIComponent(url)+"&frmHTML="+encodeURIComponent(PopupUtils.encryptText(frmHTML,chrome.runtime.id)),frmHTML,!1),callback&&callback();if($G.isChrome)return chrome.extension.getBackgroundPage().executeCodeOnNewWindow(chrome.extension.getURL("callback.html")+"?frm="+encodeURIComponent(PopupUtils.encryptText(frm,chrome.runtime.id)),frmHTML,!1),callback&&callback()}else if("_incognito"===target){if(fromContent)return chrome.runtime.sendMessage({action:"BKG-LOGIN-NEW-WINDOW",url:url,frmHTML:frmHTML,incognitoMode:!0},function(err){return err?callback&&callback(err):callback&&callback()});chrome.extension.isAllowedIncognitoAccess(function(isAllowedAccess){return isAllowedAccess?$G.isFirefox?(url=chrome.extension.getURL("callback.html")+"?url="+encodeURIComponent(url)+"&frmHTML="+encodeURIComponent(PopupUtils.encryptText(frmHTML,chrome.runtime.id)),chrome.runtime.sendMessage({action:"BKG-LOGIN-NEW-WINDOW",url:url,frmHTML:frmHTML,incognitoMode:!0},function(err){return err?callback&&callback(err):callback&&callback()})):$G.isChrome?(chrome.extension.getBackgroundPage().executeCodeOnNewWindow(url,frmHTML,!0),window.close(),callback&&callback()):void 0:callback&&callback(chrome.i18n.getMessage("popup_enable_incognito_mode"))})}else{if("_copy"===target)return PopupUtils.copyToClipboard(url+"&un="+encodeURIComponent(username)+"&pw="+encodeURIComponent(password)),window.close(),callback&&callback();if("_password"===target)return PopupUtils.copyToClipboard((password||"")+(token||"")),window.close(),callback&&callback();var w=window;if($G.isFirefox)return chrome.tabs.create({url:url},function(tab){chrome.tabs.executeScript(tab.id,{code:frmHTML,runAt:"document_end"},function(cnt){w.close()})}),callback&&callback();if($G.isChrome)return frm=$(frm).attr("target",target).attr("method","POST"),frm.hide(),$(document.body).append(frm),frm.submit(),callback&&callback()}}},executeCodeOnNewWindow:function(url,frmHTML,incognitoMode){chrome.windows.create({url:url,type:"normal",incognito:incognitoMode},function(wnd){incognitoMode&&chrome.tabs.executeScript(wnd.tabs[0].id,{code:frmHTML,runAt:"document_end"},function(cnt){})})},getGlobalPluginStorage:function(pluginId,callback){return PopupUtils.getPluginStorage(pluginId,PopupUtils.PluginStorageGlobal,callback)},setGlobalPluginStorage:function(pluginId,data,callback){return PopupUtils.setPluginStorage(pluginId,PopupUtils.PluginStorageGlobal,data,callback)},getPluginStorage:function(pluginId,orgId,callback){PopupUtils.getConfigParameterLocal([PopupUtils.StorageParamNamePluginLocalStorage],function(err,params){params||(params={});try{var pluginStorage=params[PopupUtils.StorageParamNamePluginLocalStorage];if(!pluginStorage)return callback&&callback(null,{});var pluginStorageSerialized=LZString.decompressFromEncodedURIComponent(pluginStorage);pluginStorageSerialized=pluginStorageSerialized||"{}",pluginStorage=JSON.parse(pluginStorageSerialized);var pluginStorageLimitDate=(new Date).getTime()-2592e6;for(key in pluginStorage)key!==PopupUtils.PluginStorageGlobal&&(pluginStorage[key]&&!pluginStorage[key].lastModifiedDate&&(pluginStorage[key].lastModifiedDate=(new Date).getTime()),pluginStorage[key]&&pluginStorage[key].lastModifiedDate&&pluginStorage[key].lastModifiedDate<pluginStorageLimitDate&&(pluginStorage[key]=void 0));var orgPlugins=pluginStorage[orgId||""];if(!orgPlugins)return callback&&callback(null,{});var plugin=orgPlugins[pluginId];return plugin?(key!==PopupUtils.PluginStorageGlobal&&(orgPlugins.lastModifiedDate=(new Date).getTime()),pluginStorage=LZString.compressToEncodedURIComponent(JSON.stringify(pluginStorage)),PopupUtils.setConfigParameterLocal(PopupUtils.StorageParamNamePluginLocalStorage,pluginStorage,function(err){return callback&&callback(err,plugin)})):callback&&callback(null,{})}catch(ex){return PopupUtils.logError(ex),callback&&callback(ex)}})},deletePluginStorage:function(orgId,callback){PopupUtils.getConfigParameterLocal([PopupUtils.StorageParamNamePluginLocalStorage],function(err,params){params||(params={});try{if(!orgId)return callback&&callback(new Error("Missing plugin ID and ORG Id"));var pluginStorage=params[PopupUtils.StorageParamNamePluginLocalStorage];if(pluginStorage){var pluginStorageSerialized=LZString.decompressFromEncodedURIComponent(pluginStorage);pluginStorageSerialized=pluginStorageSerialized||"{}",pluginStorage=JSON.parse(pluginStorageSerialized)}else pluginStorage={};pluginStorage[orgId]=void 0,pluginStorage=LZString.compressToEncodedURIComponent(JSON.stringify(pluginStorage)),PopupUtils.setConfigParameterLocal(PopupUtils.StorageParamNamePluginLocalStorage,pluginStorage,function(err){return callback&&callback(err)})}catch(ex){return PopupUtils.logError(ex),callback&&callback(ex)}})},setPluginStorage:function(pluginId,orgId,data,callback){PopupUtils.getConfigParameterLocal([PopupUtils.StorageParamNamePluginLocalStorage],function(err,params){params||(params={});try{if(!pluginId||!orgId)return callback&&callback(new Error("Missing plugin ID and ORG Id"));var pluginStorage=params[PopupUtils.StorageParamNamePluginLocalStorage];if(pluginStorage){var pluginStorageSerialized=LZString.decompressFromEncodedURIComponent(pluginStorage);pluginStorageSerialized=pluginStorageSerialized||"{}",pluginStorage=JSON.parse(pluginStorageSerialized)}else pluginStorage={};var orgPlugins=pluginStorage[orgId];orgPlugins||(orgPlugins={},pluginStorage[orgId]=orgPlugins),orgPlugins[pluginId]=data,orgId!==PopupUtils.PluginStorageGlobal&&(orgPlugins.lastModifiedDate=(new Date).getTime()),pluginStorage=LZString.compressToEncodedURIComponent(JSON.stringify(pluginStorage)),PopupUtils.setConfigParameterLocal(PopupUtils.StorageParamNamePluginLocalStorage,pluginStorage,function(err){return callback&&callback(err,orgPlugins[pluginId])})}catch(ex){return PopupUtils.logError(ex),callback&&callback(ex)}})},isLEX:function(url){return url=url||window.location.href,url.indexOf("/one/one.app")>0||url.indexOf("/lightning/")>0},isLightningApp:function(url){return url=url||window.location.href,url.indexOf(".lightning.force.com")>0},createMagicButton:function(orientation,isLex,darkMode){orientation=orientation||"horizontal";var orientationClass="vertical"==orientation?"mb-vertical":"mb-horizontal";isLex?orientationClass+=" mb-lightning":PopupUtils.isLightningApp()&&(orientationClass+=" mb-lightning-app");var buttonDiv=$('<div class="ui-magic-button '+orientationClass+'" title="Toggle Quick Menu"><div class="ui-magic-button-button '+orientationClass+'"><span class="ui-magic-button-container ui-magic-button-click-target '+orientationClass+'"><img src="'+chrome.extension.getURL("/img/icon.png")+'" class="ui-magic-button-container-image '+orientationClass+'" /><span class="ui-magic-button-container-title '+orientationClass+'"> <span style="font-weight:800;">org</span><span>anizer</span></span></span></div></div>'),linkContainer=$('<div class="ui-magic-button-links-container '+orientationClass+'"><div class="ui-magic-button-links-group '+orientationClass+'"><div class="ui-magic-button-link ui-magic-button-first-link ui-magic-button-quicklink-link '+orientationClass+'">Quicklinks</div><div class="ui-magic-button-link ui-magic-button-profiles-manager-link '+orientationClass+'">Profiles Chamber</div><div class="ui-magic-button-link ui-magic-button-quickconsole-link '+orientationClass+'">Quick Console</div><div class="ui-magic-button-quickconsole-links '+orientationClass+'"></div><div class="ui-magic-button-link ui-magic-button-options-link '+orientationClass+'">Options</div><div class="ui-magic-button-link ui-magic-button-options-hide '+orientationClass+'">Hide</div><div class="ui-magic-button-link ui-magic-button-sponsors '+orientationClass+'"></div></div></div>'),btn=$('<div class="ui-magic-button-root '+orientationClass+'"></div>');return darkMode&&btn.addClass("ui-dark"),"vertical"===orientation?btn.append(linkContainer).append(buttonDiv):btn.append(buttonDiv).append(linkContainer),btn},inIframe:function(){try{return window.self!==window.top}catch(e){return!0}},checkVendorMessages:function(callback){PopupUtils.loadAjaxCache(function(cache){if(cache&&cache.lastNewsCheck&&cache.newsCache&&(new Date).getTime()-cache.lastNewsCheck<$C.News_Refresh)return callback&&callback(null,cache.newsCache);var newsUrl=$C.Endpoints.News;newsUrl.indexOf("@@")>=0&&(newsUrl=$C.Endpoints.News_Dev);var options={type:"GET",cache:!0,url:newsUrl,headers:{"Content-Type":"application/json"},success:function(data,textStatus,request){cache.lastNewsCheck=(new Date).getTime(),cache.newsCache=data,debug.log("Ajax News: ",data),PopupUtils.storeAjaxCache(cache,function(){return callback&&callback(null,data)})},error:function(request,textStatus,errorThrown){return request&&request.responseText?callback&&callback({code:request.status,message:request.responseText}):callback&&callback("Unexpected error "+errorThrown)}};PopupUtils.ajaxCall(options)})},getURLParameter:function(name,url){return url=url||window.location.search,decodeURIComponent((new RegExp("[?|&]"+name+"=([^&;]+?)(&|#|;|$)").exec(url)||[null,""])[1].replace(/\+/g,"%20"))||null},shortcutToString:function(combination,compactString,joinchar){if(!combination)return"";var chars=[];return joinchar=joinchar||" + ",combination.alt&&chars.push(compactString?"ALT":"Alt"),combination.ctrl&&chars.push(compactString?"CTRL":"Control"),combination.cmd&&chars.push(compactString?"CMD":"Command"),combination.shift&&chars.push(compactString?"SHIFT":"Shift"),combination.key&&(32===combination.key?chars.push(compactString?"SPACE":"Space"):chars.push(String.fromCharCode(combination.key))),chars.join(joinchar)},backupData:function(callback){chrome.storage.local.get([PopupUtils.StorageParamNameBackupsLocalStorage,PopupUtils.StorageParamNameAccounts,PopupUtils.StorageParamNameOrgs,PopupUtils.StorageParamNameMaxBackupsNum],function(params){var MAX_BACKUP_NUM=params[PopupUtils.StorageParamNameMaxBackupsNum]||PopupUtils.MaxBackupNumDefault,backup={createdDate:(new Date).getTime(),body:{accounts:params.accounts||[],orgs:params.orgs||[]}};backup.body=LZString.compressToEncodedURIComponent(JSON.stringify(backup.body));var backups=params[PopupUtils.StorageParamNameBackupsLocalStorage]||[];backups.length&&backups[backups.length-1].body===backup.body?backups[backups.length-1]=backup:backups.push(backup),backups.length>MAX_BACKUP_NUM&&backups.splice(0,backups.length-MAX_BACKUP_NUM-1);var backupsVar={};backupsVar[PopupUtils.StorageParamNameBackupsLocalStorage]=backups,chrome.storage.local.set(backupsVar,function(params){return callback&&callback()})})},updateBackupPasswords:function(oldPwd,newPwd,callback){chrome.storage.local.get([PopupUtils.StorageParamNameBackupsLocalStorage],function(params){var backups=params[PopupUtils.StorageParamNameBackupsLocalStorage]||[];if(!backups||!Array.isArray(backups)||!backups.length)return callback&&callback();for(var i=0;i<backups.length;i++){var backup=backups[i],body=LZString.decompressFromEncodedURIComponent(backup.body);if(backup.body=JSON.parse(body),backup.body.accounts&&backup.body.accounts.length)for(var ai=0;ai<backup.body.accounts.length;ai++)if(backup.body.accounts[ai].p)if(oldPwd)backup.body.accounts[ai].p=PopupUtils.decryptText(backup.body.accounts[ai].p,oldPwd);else{var tmp=backup.body.accounts[ai].p;try{backup.body.accounts[ai].p=PopupUtils.deobfuscate(backup.body.accounts[ai].p)}catch(ex){backup.body.accounts[ai].p=null}backup.body.accounts[ai].p||(backup.body.accounts[ai].p=tmp)}if(backup.body.accounts&&backup.body.accounts.length)for(var ai=0;ai<backup.body.accounts.length;ai++)backup.body.accounts[ai].p&&newPwd&&(backup.body.accounts[ai].p=PopupUtils.encryptText(backup.body.accounts[ai].p,newPwd));backup.body=LZString.compressToEncodedURIComponent(JSON.stringify(backup.body))}PopupUtils.setConfigParameterLocal(PopupUtils.StorageParamNameBackupsLocalStorage,backups,function(){return callback&&callback()})})},parseOAuthPageUrlWebServerFlow:function(callback){var code=(window.location.href,PopupUtils.getURLParameter("code")||""),state=PopupUtils.getURLParameter("state")||"",error=PopupUtils.getURLParameter("error"),errorDescription=PopupUtils.getURLParameter("error_description");if(error){var username=state.split("_#_")[0];return callback&&callback(!0,!1,{username:username,error:error,error_description:errorDescription})}if(code){state=decodeURIComponent(state);var username=state.split("_#_")[0],originUrl=state.split("_#_")[1],url=originUrl+"/services/oauth2/token",consumerKey=$C.SF_API.CONSUMER_KEY;consumerKey.indexOf("@@")>=0&&(consumerKey=$C.SF_API.CONSUMER_KEY_DEV);var body="grant_type=authorization_code&client_id="+encodeURIComponent(consumerKey)+"&redirect_uri="+encodeURIComponent(chrome.extension.getURL("callback.html"))+"&code="+encodeURIComponent(code);return $.ajax({url:url,method:"POST",data:body,headers:{Accept:"application/json"},success:function(result,status,xhr){PopupUtils.getUserInfo(result.id,result.access_token,function(err,userInfo){return result.userId=result.id.split("/")[5],result.orgId=result.id.split("/")[4],username=result.username,result.username=userInfo.username,chrome.storage.local.get([PopupUtils.StorageParamNameRefreshTokens],function(params){return params=params||{},result.access_token=PopupUtils.encryptText(result.access_token||"",chrome.runtime.id),result.refresh_token=PopupUtils.encryptText(result.refresh_token||"",chrome.runtime.id),params[PopupUtils.StorageParamNameRefreshTokens]?(params[PopupUtils.StorageParamNameRefreshTokens]=decodeURIComponent(LZString.decompressFromEncodedURIComponent(params[PopupUtils.StorageParamNameRefreshTokens])),params[PopupUtils.StorageParamNameRefreshTokens]=JSON.parse(params[PopupUtils.StorageParamNameRefreshTokens])):params[PopupUtils.StorageParamNameRefreshTokens]={},params[PopupUtils.StorageParamNameRefreshTokens][result.username]=result,params[PopupUtils.StorageParamNameRefreshTokens]=LZString.compressToEncodedURIComponent(encodeURIComponent(JSON.stringify(params[PopupUtils.StorageParamNameRefreshTokens]))),chrome.storage.local.set(params,function(){return callback&&callback(!0,!0,result)})})})},error:function(data){return callback&&callback(!0,!1,data)}})}return callback&&callback(!1)},doRefreshToken:function(username,serverUrl,refToken,callback){var url=serverUrl+"/services/oauth2/token",consumerKey=$C.SF_API.CONSUMER_KEY;consumerKey.indexOf("@@")>=0&&(consumerKey=$C.SF_API.CONSUMER_KEY_DEV);var body="grant_type=refresh_token&client_id="+encodeURIComponent(consumerKey)+"&refresh_token="+encodeURIComponent(refToken);$.ajax({url:url,method:"POST",data:body,headers:{Accept:"application/json"},success:function(result,status,xhr){return result.refresh_token=refToken,result.userId=result.id.split("/")[5],result.username=username,result.orgId=result.id.split("/")[4],chrome.storage.local.get([PopupUtils.StorageParamNameRefreshTokens],function(params){params=params||{};var at=result.access_token,rt=result.refresh_token;return result.access_token=PopupUtils.encryptText(at||"",chrome.runtime.id),result.refresh_token=PopupUtils.encryptText(rt||"",chrome.runtime.id),params[PopupUtils.StorageParamNameRefreshTokens]?(params[PopupUtils.StorageParamNameRefreshTokens]=decodeURIComponent(LZString.decompressFromEncodedURIComponent(params[PopupUtils.StorageParamNameRefreshTokens])),params[PopupUtils.StorageParamNameRefreshTokens]=JSON.parse(params[PopupUtils.StorageParamNameRefreshTokens])):params[PopupUtils.StorageParamNameRefreshTokens]={},params[PopupUtils.StorageParamNameRefreshTokens][username]=result,params[PopupUtils.StorageParamNameRefreshTokens]=LZString.compressToEncodedURIComponent(encodeURIComponent(JSON.stringify(params[PopupUtils.StorageParamNameRefreshTokens]))),chrome.storage.local.set(params,function(){return result.access_token=at,result.refresh_token=rt,callback&&callback(null,result)})})},error:function(data){return callback&&callback(data)}})},startOAuthFlow:function(username,server){var scopes=["web","api","refresh_token"],consumerKey=$C.SF_API.CONSUMER_KEY;consumerKey.indexOf("@@")>=0&&(consumerKey=$C.SF_API.CONSUMER_KEY_DEV);var url=server+"/services/oauth2/authorize?response_type=code&client_id="+encodeURIComponent(consumerKey)+"&state="+encodeURIComponent(username+"_#_"+server)+"&immediate=false&prompt=login&redirect_uri="+encodeURIComponent(chrome.extension.getURL("callback.html"))+"&scope="+scopes.join("%20")+"&display=popup";return url},getUserInfo:function(userUrl,accessToken,callback){$.ajax({url:userUrl,method:"GET",headers:{Authorization:"Bearer "+accessToken},success:function(result,status,xhr){return callback&&callback(null,result)},error:function(data){return callback&&callback(data)}})},revokeOAuthToken:function(token,oauthServer,callback){Number.isInteger(parseInt(oauthServer))&&(oauthServer=PopupUtils.StandardLoginURLs[parseInt(oauthServer)]),oauthServer||(oauthServer=PopupUtils.StandardLoginURLs[0]),$.ajax({url:oauthServer+"/services/oauth2/revoke",method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:"token="+encodeURIComponent(token),success:function(result,status,xhr){return callback&&callback(null,result)},error:function(data){return callback&&callback(data)}})},getOAuthTokenData:function(oauthUsername,oauthServer,landingPage,doRefresh,callback){chrome.storage.local.get([PopupUtils.StorageParamNameRefreshTokens],function(params){params=params||{},params[PopupUtils.StorageParamNameRefreshTokens]?(params[PopupUtils.StorageParamNameRefreshTokens]=decodeURIComponent(LZString.decompressFromEncodedURIComponent(params[PopupUtils.StorageParamNameRefreshTokens])),params[PopupUtils.StorageParamNameRefreshTokens]=JSON.parse(params[PopupUtils.StorageParamNameRefreshTokens])):params[PopupUtils.StorageParamNameRefreshTokens]={};var token=params[PopupUtils.StorageParamNameRefreshTokens][oauthUsername];return debug.log("Oauth: Selected token",token),token?(token.access_token=PopupUtils.decryptText(token.access_token||"",chrome.runtime.id),token.refresh_token=PopupUtils.decryptText(token.refresh_token||"",chrome.runtime.id),doRefresh?void PopupUtils.getUserInfo(token.id,token.access_token,function(err,data){return debug.log("Oauth: Get User Info",err,data),!data&&err&&403===err.status?PopupUtils.doRefreshToken(oauthUsername,oauthServer,token.refresh_token,function(err,result){return debug.log("Oauth: Refresh",err,result),callback&&callback(err,result)}):callback&&callback(err,token)}):callback&&callback(null,token)):!token&&oauthUsername&&oauthServer?callback&&callback(new Error("No OAuth Data: launch OAuth flow")):void 0})},confirmSessionIdUrl:function(instanceUrl,accessToken,landingPage){return instanceUrl+"/secur/frontdoor.jsp?sid="+accessToken+"&retURL="+(landingPage||"")},addItemInHistory:function(oid,historyItem,callback){PopupUtils.getConfigParameterLocal(PopupUtils.StorageParamNameQuickLinkHistory,function(err,params){if(err)return callback&&callback(err);var _storedParamsOrgs=(params||{})[PopupUtils.StorageParamNameQuickLinkHistory]||{};
_storedParamsOrgs[oid]=_storedParamsOrgs[oid]||[],_storedParamsOrgs[oid].push(historyItem),_storedParamsOrgs[oid].length>PopupUtils.MaxQuickLinkHistorySize&&_storedParamsOrgs[oid].splice(0,1),PopupUtils.setConfigParameterLocal(PopupUtils.StorageParamNameQuickLinkHistory,_storedParamsOrgs,function(err){return callback&&callback(err)})})},deleteOrgHistory:function(oid,callback){if(!oid)throw new Error("Invalid ORGanization ID");PopupUtils.getConfigParameterLocal(PopupUtils.StorageParamNameQuickLinkHistory,function(err,params){if(err)return callback&&callback(err);var _storedParamsOrgs=(params||{})[PopupUtils.StorageParamNameQuickLinkHistory]||{};_storedParamsOrgs[oid]=_storedParamsOrgs[oid]||[],delete _storedParamsOrgs[oid],PopupUtils.setConfigParameterLocal(PopupUtils.StorageParamNameQuickLinkHistory,_storedParamsOrgs,function(err){return callback&&callback(err)})})},addQuickLink:function(oid,serverName,quickLink,callback){PopupUtils.getConfigParameterLocal(PopupUtils.StorageParamNameOrgs,function(err,params){if(err)return callback&&callback(err);for(var _storedParamsOrgs=(params||{})[PopupUtils.StorageParamNameOrgs],server=null,i=0;i<_storedParamsOrgs.length;i++)if(_storedParamsOrgs[i].oid===oid){server=_storedParamsOrgs[i];break}server||(server={oid:oid,n:serverName},_storedParamsOrgs.push(server));var ql=server.ql,qlList=JSON.parse(ql||"[]");qlList.push(quickLink),server.ql=JSON.stringify(qlList),PopupUtils.setConfigParameterLocal(PopupUtils.StorageParamNameOrgs,_storedParamsOrgs,function(err,params){return err?callback&&callback(err):void PopupUtils.syncData({noQuotaCheck:!0},function(err){return callback&&callback(err)})})})},pinEnabled:function(pinConfiguration){return!!pinConfiguration},pinExpired:function(pinCongiguration){if(pinCongiguration=pinCongiguration||null,PopupUtils.pinEnabled(pinCongiguration)){var frequency=pinCongiguration[PopupUtils.StorageParamNamePinFrequency]||0,lastCheck=pinCongiguration[PopupUtils.StorageParamNamePinLastCheckTime]||0;if((new Date).getTime()>=lastCheck+1e3*frequency*60)return!0}return!1},updatePinLastCheck:function(pinCongiguration){pinCongiguration&&(pinCongiguration[PopupUtils.StorageParamNamePinLastCheckTime]=(new Date).getTime(),PopupUtils.setConfigParameterLocal(PopupUtils.StorageParamNamePin,pinCongiguration))},isSalesforceId:function(id){return/^([a-zA-Z0-9]{15}|[a-zA-Z0-9]{18})$/.test(id||"")},observeDOM:function(){var MutationObserver=window.MutationObserver||window.WebKitMutationObserver;window.addEventListener;return function(obj,callback){var _obs=new MutationObserver(function(mutations,observer){(mutations[0].addedNodes.length||mutations[0].removedNodes.length)&&callback()});return _obs.observe(obj,{childList:!0,subtree:!0}),_obs}}(),unobserveDOM:function(observer){observer&&observer.disconnect()},createStandardVisualforcePageMessage:function(title,message,type){type=type||"info",type=type.toLowerCase(),"warning"!==type&&"error"!==type&&"confirm"!==type&&"info"!==type&&(type="info");var pm=$('<div class="message '+type+'M4" role="alert"><table border="0" cellpadding="0" cellspacing="0" class="messageTable" style="padding:0px;margin:0px;"><tbody><tr valign="top"><td><img alt="confirm" class="msgIcon" src="/s.gif" title="confirm"></td><td class="messageCell"><div class="messageText"><span><h4 class="ui-pm-title"></h4></span><span class="ui-pm-msg"></span><br></div></td></tr><tr><td></td><td></td></tr></tbody></table></div>');return pm.find(".ui-pm-title").html(title||""),pm.find(".ui-pm-msg").html(message||""),pm},regexIndexOf:function(str,regex,startpos){var indexOf=(str||"").substring(startpos||0).search(regex);return indexOf>=0?indexOf+(startpos||0):indexOf},trackAnalyticsEvent:function(eventAction,eventCategory){if(!window||!window._gaq)return void debug.log("Unable to send analytics evet: [_gaq] undefined.");if($G.isFirefox);else{var version=null;try{version=chrome.runtime.getManifest().version,debug.log("trackAnalyticsEvent.version: ",version)}catch(ex){debug.log("Cannot get extension version: "+ex)}window._gaq.push(["_trackEvent",eventCategory,eventAction,version])}},sendAnalyticsEventToBackground:function(eventAction,eventCategory,callback){chrome.runtime.sendMessage({action:"BKG-SEND-ANALYTICS-EVENT",eventCategory:eventCategory,eventAction:eventAction},function(response){return callback&&callback(response)})},trackAnalyticsPageView:function(){var pageName=window.location.pathname;if(window&&window._gaq){var request=new XMLHttpRequest,message="v=1&tid="+$C.Analytics.AccountId+"&cid=555&aip=1&ds=add-on&t=pageview&dp="+encodeURIComponent(pageName);request.open("POST","https://www.google-analytics.com/collect",!0),request.send(message)}},newDebugger:function(prefix){prefix=prefix||"ORGanizer";var _debugEnabled=!1;return chrome.storage.local.get(["debug"],function(params){params=params,params.debug&&(_debugEnabled=!0)}),{log:function(){var dt=(new Date).toISOString(),args=Array.prototype.slice.call(arguments);args.unshift("["+dt+" | "+prefix+"] "),_debugEnabled&&console.log.apply(console,args)},warn:function(){var dt=(new Date).toISOString(),args=Array.prototype.slice.call(arguments);args.unshift("["+dt+" | "+prefix+"] "),console.warn.apply(console,args)},error:function(){var dt=(new Date).toISOString(),args=Array.prototype.slice.call(arguments);args.unshift("["+dt+" | "+prefix+"] "),console.error.apply(console,args)}}},handleCSSImageReferences:function(){var loadFonts=function(){var bsFont=document.createElement("style");bsFont.type="text/css",bsFont.textContent='@font-face { font-family: Glyphicons Halflings; src: url("'+chrome.extension.getURL("libs/bootstrap/fonts/glyphicons-halflings-regular.woff")+'"); }',document.head.appendChild(bsFont);var fa=document.createElement("style");fa.type="text/css",fa.textContent='@font-face { font-family: FontAwesome; src: url("'+chrome.extension.getURL("libs/fontawesome/fonts/fontawesome-webfont.woff")+'"); }',document.head.appendChild(fa)};$G.isFirefox&&($(".ui-logo").each(function(){var url=($(this).css("background-image")||"").replace("chrome-extension","moz-extension");$(this).css("background-image",url)}),loadFonts())},openConfirmModal:function(title,message,xpos,ypos,callback){if(!_modal){_modal=$('<div class="bnsn"> <div class="ui-cs-backdrop">&nbsp;</div> <div class="modal fade in" style="display: block; position:absolute">  <div class="modal-dialog" style="">    <div class="modal-content" style="z-index:999999; text-align: left;margin: 10px auto;display: inline-block;vertical-align: middle;">      <div class="modal-header">        <div class="ui-logo" style="width:20px;height:20px;float:left;margin-right:10px;">&nbsp;</div>        <button type="button" class="close" >&times;</button>        <h4 class="modal-title"></h4>      </div>      <div class="modal-body" />      <div class="modal-footer" style="text-align:center; padding: 5px;">        <button type="button" class="btn btn-primary btn-sm btn-yes" >Yes</button>        <button type="button" class="btn btn-default btn-sm btn-no" >No</button>      </div>    </div>  </div></div></div>'),$("body").append(_modal),_modal.find(".modal").modal({keyboard:!1,show:!0,backdrop:!1});var dismissModal=function(){_modal.find(".ui-cs-backdrop").hide(),_modal.find(".modal").modal("hide").removeClass("in")};_modal.find("button.close").on("click",function(){dismissModal()}),_modal.find("h4.modal-title").show().html("").html(title),title||_modal.find("h4.modal-title").hide(),_modal.find("div.modal-body").show().html("").html(message),message||_modal.find("div.modal-body").hide(),_modal.find("button.btn-yes").click(function(){return dismissModal(),callback&&callback(!0)}),_modal.find("button.btn-no").click(function(){return dismissModal(),callback&&callback(!1)}),$(".modal-open").on("keyup",function(e){27==e.which&&dismissModal()}),_modal.find(".ui-cs-backdrop").click(function(){dismissModal()})}_modal.find(".modal").modal("show").css({top:ypos,left:xpos}).addClass("in"),_modal.find(".ui-cs-backdrop").show(),_modal.find("button.btn-no").focus()},getCookieStoreFromTabId:function(tabId,callback){chrome.cookies.getAllCookieStores(function(stores){debug.log("stores",stores,"tabId",tabId);for(var cookiestore=null,csi=0;csi<stores.length;csi++)if(stores[csi].tabIds.indexOf(tabId)>=0){cookiestore=stores[csi].id;break}return callback&&callback(cookiestore||0)})},trySendResponse:function(payload,sendResponse){try{return sendResponse&&sendResponse(payload||{})}catch(ex){debug.warn("trySendResponse",ex,payload)}},getORGParams:function(tabId,tabUrl,isLex,isFromAPI,orgDescribe,purchasedProducts,actionsLimitHit,sendResponse){PopupUtils.getCookieStoreFromTabId(tabId,function(storeId){chrome.cookies.getAll({name:"sid",url:tabUrl,storeId:storeId},function(cookies){if(!cookies||!cookies.length||!cookies[0].value)return PopupUtils.trySendResponse({error:!0,details:"No cookie sid found"},sendResponse);var oid=cookies[0].value.split("!")[0],myDomain=(cookies[0].domain||"").split(/\./g)[0],isMyDomain=PopupUtils.isMyDomain(myDomain);debug.log("MyDomain: ",myDomain,isMyDomain),PopupUtils.getConfigParameterLocal([PopupUtils.StorageParamNameOrgs,PopupUtils.StorageParamNameShortcuts,PopupUtils.StorageParamNameAccounts,PopupUtils.StorageParamNameBetaFeatures,PopupUtils.StorageParamNameQuickLinkHistory,PopupUtils.StorageParamNameApiLevel],function(err,params){if(err||!params)return PopupUtils.trySendResponse({error:!0,details:err||"No local storage parameter found"},sendResponse);var orgsSettings=params[PopupUtils.StorageParamNameOrgs],shortcuts=params[PopupUtils.StorageParamNameShortcuts]||PopupUtils.DefaultShortcuts;shortcuts.scPlugins||(shortcuts.scPlugins=PopupUtils.DefaultShortcuts.scPlugins),shortcuts.scPluginsAction||(shortcuts.scPluginsAction=PopupUtils.DefaultShortcuts.scPluginsAction);var accounts=params[PopupUtils.StorageParamNameAccounts]||[],betaFeatures=params[PopupUtils.StorageParamNameBetaFeatures]||PopupUtils.BetaFeaturesDefault,historyLinks=(params[PopupUtils.StorageParamNameQuickLinkHistory]||{})[oid]||[],apiLevel=params[PopupUtils.StorageParamNameApiLevel]||$C.SF_API.LEVEL;if(!orgsSettings)return PopupUtils.trySendResponse({error:!0,details:"No ORG Setting found"},sendResponse);for(var org=null,i=0;i<orgsSettings.length;i++)if(isMyDomain&&myDomain.toUpperCase()===orgsSettings[i].n.toUpperCase()||oid===orgsSettings[i].oid){org=orgsSettings[i];var oldid=orgsSettings[i].oid,oldLastTimeAccess=orgsSettings[i].d,oldDomain=orgsSettings[i].n;orgsSettings[i].oid=oid,orgsSettings[i].n=myDomain.toUpperCase(),orgsSettings[i].d=(new Date).getTime(),(orgsSettings[i].d>oldLastTimeAccess+864e5||oldid!==orgsSettings[i].oid||oldDomain!==orgsSettings[i].n)&&(oldid!==orgsSettings[i].oid&&PopupUtils.switchOrgRelatedLocalData({newOrgId:orgsSettings[i].oid,oldOrgId:oldid},function(err){err&&console.error("Error calling PopupUtils.switchOrgRelatedLocalData()",err)}),PopupUtils.setConfigParameterLocal(PopupUtils.StorageParamNameOrgs,orgsSettings));break}org||(org={n:myDomain,oid:oid}),debug.log("Found org:",org);for(var tmp=[],hi=historyLinks.length-1;hi>=0;hi--)tmp.push(historyLinks[hi]);historyLinks=tmp,chrome.extension.isAllowedIncognitoAccess(function(isAllowedAccess){PopupUtils.getActiveSessions(tabId,storeId,function(err,sessions){sessions=sessions||{};for(var links=PopupUtils.getSFLinks((sessions[oid]||{}).domain,isLex),customQuickLinks=JSON.parse(org.ql||"[]"),j=0;j<customQuickLinks.length;j++)customQuickLinks[j].isCustom=!0;var quickLinks=customQuickLinks,message={action:"CNT-SET-ORG-PARAMS",title:org.l,color:org.c,oid:oid,myDomain:isMyDomain?myDomain:null,domain:(sessions[oid]||{}).domain||null,domainAPI:(sessions[oid]||{}).domainAPI||null,sid:(sessions[oid]||{}).sid||null,links:links,historyLinks:historyLinks,quickLinks:quickLinks,accounts:accounts,shortcuts:shortcuts,betaFeatures:betaFeatures,from:"BKG",apiLevel:apiLevel,incognitoSupported:isAllowedAccess,products:purchasedProducts,actionsLimitHit:actionsLimitHit},orgDescr=orgDescribe[message.oid];if(orgDescr&&orgDescr.LastQueryDate&&!(orgDescr.LastQueryDate<(new Date).getTime()-6e5))return message.objectQuicklinks=orgDescribe[message.oid].objectQuicklinks,isFromAPI?PopupUtils.trySendResponse(message,sendResponse):chrome.tabs.sendMessage(tabId,message);var $client=new $SalesforceClient.Client("https://"+message.domainAPI,message.sid,apiLevel);$client.globalDescribe(function(err,rslt){function sequentialCall(clause){return function(){return debug.log("Describe function #"+(_functions.length-1)),queryObjectChunk(clause),_functions.splice(0,1),_functions.length?void _functions[0]():isFromAPI?(debug.log("Return from APIs..."),PopupUtils.trySendResponse(message,sendResponse)):chrome.tabs.sendMessage(tabId,message)}}if(err)return message.objectQuicklinks=(orgDescribe[message.oid]||{}).objectQuicklinks,void chrome.tabs.sendMessage(tabId,message);message.describeGlobal=rslt;var layoutables=[];for(key in rslt){var descr=rslt[key];descr.layoutable&&layoutables.push(key)}orgDescribe[message.oid]={describe:rslt},orgDescribe[message.oid].LastQueryDate=(new Date).getTime();for(var tmpINClauses=[],tmpClause="",i=0;i<layoutables.length;i++)tmpClause+="'"+layoutables[i]+"'",tmpClause.length<5e3&&i<layoutables.length-1?tmpClause+=",":(tmpINClauses.push(tmpClause),tmpClause="");for(var queryObjectChunk=function(inClause,callback){var query="select+id,DurableId,QualifiedApiName,developername,NamespacePrefix,KeyPrefix+from+EntityDefinition+where+qualifiedapiname+IN+("+inClause+")";$client.toolingAPIQuery(query,function(err,rslt){if(err)return message.objectQuicklinks=(orgDescribe[message.oid]||{}).objectQuicklinks,callback&&callback();orgDescribe[message.oid].objectQuicklinks=[];for(var i=0;i<rslt.records.length;i++){var obj=rslt.records[i];orgDescribe[message.oid].describe[obj.QualifiedApiName].DurableId=obj.DurableId,orgDescribe[message.oid].describe[obj.QualifiedApiName].NamespacePrefix=obj.NamespacePrefix}for(key in orgDescribe[message.oid].describe){var descr=orgDescribe[message.oid].describe[key];if(descr.layoutable&&descr.DurableId)for(var ui=0;ui<$C.ObjectQuickLinks.length;ui++){var objUrl=$C.ObjectQuickLinks[ui];objUrl.onlyCustom&&!descr.custom||objUrl.onlyStandard&&descr.custom||objUrl.onlyCreatable&&!descr.createable||objUrl.onlyLex&&!isLex||objUrl.noLex&&isLex||orgDescribe[message.oid].objectQuicklinks.push({l:objUrl.label.replace("{DurableId}",descr.DurableId).replace("{QualifiedApiName}",descr.name).replace("{Label}",descr.label).replace("{NamespacePrefix}",descr.NamespacePrefix?" ("+descr.NamespacePrefix+") ":"").replace("{KeyPrefix}",descr.keyPrefix),n:objUrl.label.replace("{DurableId}",descr.DurableId).replace("{QualifiedApiName}",descr.name).replace("{Label}",descr.label).replace("{NamespacePrefix}",descr.NamespacePrefix?" ("+descr.NamespacePrefix+") ":"").replace("{KeyPrefix}",descr.keyPrefix),p:objUrl.url?objUrl.url.replace("{DurableId}",descr.DurableId).replace("{QualifiedApiName}",descr.name).replace("{Label}",descr.label).replace("{KeyPrefix}",descr.keyPrefix):"",plex:objUrl.urlLex?objUrl.urlLex.replace("{DurableId}",descr.DurableId).replace("{QualifiedApiName}",descr.name).replace("{Label}",descr.label).replace("{KeyPrefix}",descr.keyPrefix):""})}}return message.objectQuicklinks=orgDescribe[message.oid].objectQuicklinks,callback&&callback()})},_functions=[],i=0;i<tmpINClauses.length;i++)_functions.push(sequentialCall(tmpINClauses[i]));debug.log("Describe functions: "+_functions.length),_functions.length&&_functions[0]()})},isLex)})})})})},checkIfSobjectPage:function(isLex){var url=window.location.href;if(!url)return!1;if(!isLex){var splitUrl=url.split("?")[0].split("/"),id=splitUrl[splitUrl.length-1];return id=id.split("?")[0],id=id.split("#")[0],PopupUtils.isSalesforceId(id)}if(url.toLowerCase().indexOf("one.app")>0){var splitUrl=url.split("#");if(splitUrl.length<2)return!1;var id=splitUrl[1].split("#")[0];return id=id.replace("/sObject/",""),id=id.split("/")[0],PopupUtils.isSalesforceId(id)}if(url.toLowerCase().indexOf("/lightning/r/")>0){var splitUrl=url.replace("/view","").split("/"),id=splitUrl[splitUrl.length-1];return PopupUtils.isSalesforceId(id)}},getSFIdFromUrl:function(url,isLex){if(url=url||"",!url)throw new Error("Invalid Sobject URL (1)");if(!isLex){var splitUrl=url.split("?")[0].split("/"),id=splitUrl[splitUrl.length-1];return id=id.split("?")[0],id.split("#")[0]}if(url.toLowerCase().indexOf("one.app")>0){var splitUrl=url.split("#");if(splitUrl.length<2)return!1;var id=splitUrl[1].split("#")[0];return id=id.replace("/sObject/",""),id.split("/")[0]}if(url.toLowerCase().indexOf("/lightning/r/")>0){var splitUrl=url.split("?")[0].replace("/view","").split("/"),id=splitUrl[splitUrl.length-1];return id}},getRandomInt:function(min,max){return Math.floor(Math.random()*(max-min+1))+min},shuffleArray:function(array){for(var temporaryValue,randomIndex,currentIndex=array.length;0!==currentIndex;)randomIndex=Math.floor(Math.random()*currentIndex),currentIndex-=1,temporaryValue=array[currentIndex],array[currentIndex]=array[randomIndex],array[randomIndex]=temporaryValue;return array},getSponsors:function(options,callback){options=options||{},debug.log("getSponsors",options);var filterResults=function(data){for(var i=data.length-1;i>=0;i--)options.location&&data[i].location!==options.location&&data.splice(i,1);return PopupUtils.shuffleArray(data)};_adsEnabled=!0;for(var i=0;i<(options.products||[]).length;i++){var product=options.products[i];if("ACTIVE"===product.state){var category=PopupUtils.extractCategoryFromSku(product.sku);debug.log("check no ad: ",$C.InAppPurchases.NO_AD_PRODUCT_CODE,category),$C.InAppPurchases.NO_AD_PRODUCT_CODE===category&&(_adsEnabled=!1)}}return _adsEnabled!==!0?(_sponsorsCash=[],callback&&callback(null,_sponsorsCash)):void PopupUtils.loadAjaxCache(function(cache){if(cache&&cache.lastSponsorCheck&&cache.sponsorsCache&&(new Date).getTime()-cache.lastSponsorCheck<$C.Sponsors_Refresh){_sponsorsCash=cache.sponsorsCache;var data=JSON.parse(JSON.stringify(_sponsorsCash));return callback&&callback(null,filterResults(data))}var doSponsorsCallout=function(){var url=$C.Endpoints.Sponsors;url.indexOf("@@")>=0&&(url=$C.Endpoints.Sponsors_DEV),$G.isChrome||(url=chrome.extension.getURL("resources/spns.json")),debug.log("doSponsorsCallout url:",url);var options={type:"GET",cache:!0,url:url,headers:{"Content-Type":"application/json"},success:function(data,textStatus,request){data=data||[],debug.log("doSponsorsCallout",data);for(var di=0;di<data.length;di++)data[di].companyUrl=PopupUtils.addSponsorLinkObfuscatedParam(data[di].companyUrl);_sponsorsCash=JSON.parse(JSON.stringify(data)),cache.lastSponsorCheck=(new Date).getTime(),cache.sponsorsCache=_sponsorsCash,PopupUtils.storeAjaxCache(cache,function(){return callback&&callback(null,filterResults(data))})},error:function(request,textStatus,errorThrown){return request&&request.responseText?callback&&callback({code:request.status,message:request.responseText}):callback&&callback("Unexpected error "+errorThrown)}};PopupUtils.ajaxCall(options)};return doSponsorsCallout()})},fuzzySearchSimple:function(pattern,str){for(var patternIdx=0,strIdx=0,patternLength=pattern.length,strLength=str.length;patternIdx!=patternLength&&strIdx!=strLength;){var patternChar=pattern.charAt(patternIdx).toLowerCase(),strChar=str.charAt(strIdx).toLowerCase();patternChar==strChar&&++patternIdx,++strIdx}return 0!=patternLength&&0!=strLength&&patternIdx==patternLength},fuzzySearch:function(pattern,str){for(var adjacency_bonus=10,separator_bonus=5,camel_bonus=0,leading_letter_penalty=0,max_leading_letter_penalty=-9,unmatched_letter_penalty=0,score=0,patternIdx=0,patternLength=pattern.length,strIdx=0,strLength=str.length,prevMatched=!1,prevLower=!1,prevSeparator=!0,bestLetter=null,bestLower=null,bestLetterIdx=null,bestLetterScore=0,matchedIndices=[];strIdx!=strLength;){var patternChar=patternIdx!=patternLength?pattern.charAt(patternIdx):null,strChar=str.charAt(strIdx),patternLower=null!=patternChar?patternChar.toLowerCase():null,strLower=strChar.toLowerCase(),strUpper=strChar.toUpperCase(),nextMatch=patternChar&&patternLower==strLower,rematch=bestLetter&&bestLower==strLower,advanced=nextMatch&&bestLetter,patternRepeat=bestLetter&&patternChar&&bestLower==patternLower;if((advanced||patternRepeat)&&(score+=bestLetterScore,matchedIndices.push(bestLetterIdx),bestLetter=null,bestLower=null,bestLetterIdx=null,bestLetterScore=0),nextMatch||rematch){var newScore=0;if(0==patternIdx){var penalty=Math.max(strIdx*leading_letter_penalty,max_leading_letter_penalty);score+=penalty}prevMatched&&(newScore+=adjacency_bonus),prevSeparator&&(newScore+=separator_bonus),prevLower&&strChar==strUpper&&strLower!=strUpper&&(newScore+=camel_bonus),nextMatch&&++patternIdx,newScore>=bestLetterScore&&(null!=bestLetter&&(score+=unmatched_letter_penalty),bestLetter=strChar,bestLower=bestLetter.toLowerCase(),bestLetterIdx=strIdx,bestLetterScore=newScore),prevMatched=!0}else formattedStr+=strChar,score+=unmatched_letter_penalty,prevMatched=!1;prevLower=strChar==strLower&&strLower!=strUpper,prevSeparator="_"==strChar||" "==strChar,++strIdx}bestLetter&&(score+=bestLetterScore,matchedIndices.push(bestLetterIdx));for(var formattedStr="",lastIdx=0,i=0;i<matchedIndices.length;++i){var idx=matchedIndices[i];formattedStr+=str.substr(lastIdx,idx-lastIdx)+"[_b_]"+str.charAt(idx)+"[_/b_]",lastIdx=idx+1}formattedStr+=str.substr(lastIdx,str.length-lastIdx);var matched=patternIdx==patternLength;return{matches:matched,score:score,formattedString:formattedStr}},getGlobalSearchLink:function(isLex,term){return isLex?PopupUtils.LEX_PATH_PREFIX+encodeURIComponent(btoa(JSON.stringify({componentDef:"forceSearch:search",attributes:{term:term,scopeMap:{type:"TOP_RESULTS"},context:{disableSpellCorrection:!1,permsAndPrefs:{"SearchResultsLVM.lvmEnabledForSearchResultsOn":!0}}},state:{}}))):PopupUtils.GlobalSearchUrl+encodeURIComponent(term)},getAvailableStoreProducts:function(callback){return callback&&callback(null,{response:{details:{inAppProducts:[]}}})},getPurchasedStoreProducts:function(callback){return!$G.isChrome||$G.isEdge?callback&&callback(null,{response:{details:[]}}):google.payments.inapp.getPurchases({parameters:{env:"prod"},success:function(prodList){return callback&&callback(null,prodList)},failure:function(err){return debug.log("Error retrieving products from web store: ",err),callback&&callback(err)}})},buyProduct:function(sku,callback){return $G.isChrome?void google.payments.inapp.buy({parameters:{env:"prod"},sku:sku,success:function(result){return callback&&callback(null,result)},failure:function(err){return debug.log("Error retrieving products from web store: ",err),callback&&callback(err)}}):callback&&callback(new Error("Only Google Chrome is supported"))},extractCategoryFromSku:function(sku){return sku&&sku.trim()?sku.substring(0,sku.lastIndexOf("_")+1)||null:null},formatMoney:function(value,c,d,t){var n=value,c=isNaN(c=Math.abs(c))?2:c,d=void 0==d?".":d,t=void 0==t?",":t,s=n<0?"-":"",i=String(parseInt(n=Math.abs(Number(n)||0).toFixed(c))),j=(j=i.length)>3?j%3:0;return s+(j?i.substr(0,j)+t:"")+i.substr(j).replace(/(\d{3})(?=\d)/g,"$1"+t)+(c?d+Math.abs(n-i).toFixed(c).slice(2):"")},getSellableProducts:function(options,callback){options=options||{};var url=$C.Endpoints.InAppProductsEndpoint;url.indexOf("@@")>=0&&(url=$C.Endpoints.InAppProductsEndpoint_DEV),debug.log("getSellableProducts",options,url);var filterResults=function(products){return products=products||[],products.sort(function(a,b){var aFamily=(a.family||"").toLowerCase(),bFamily=(b.family||"").toLowerCase(),aTitle=(a.title||"").toLowerCase();(b.title||"").toLowerCase();return aFamily>bFamily?1:aFamily<bFamily?-1:aTitle>aTitle?1:aTitle<aTitle?-1:0}),products},doProductsCallout=function(){var options={type:"GET",cache:!0,url:url,headers:{"Content-Type":"application/json"},success:function(data,textStatus,request){return data=data||[],callback&&callback(null,filterResults(data))},error:function(request,textStatus,errorThrown){return request&&request.responseText?callback&&callback({code:request.status,message:request.responseText}):callback&&callback("Unexpected error "+errorThrown)}};PopupUtils.ajaxCall(options)};return doProductsCallout()},skipIllegalFilenameChars:function(filename,skipChar){return filename=filename||"",null!==skipChar&&void 0!==skipChar||(skipChar="-"),filename.replace(/[/\\?%*:|"<>]/g,skipChar)},addSponsorLinkObfuscatedParam:function(link){if(!link)return"";var param=PopupUtils.encryptText((new Date).toISOString(),$C.Chrome_Prod_Id);return link.replace("{token}",encodeURIComponent(param))},loadLocalMainData:function(callback){var returnObject={};PopupUtils.getLocalPassphrase(function(err,pwd){return err?callback&&callback(err):(returnObject.storedPassPhrase=pwd||null,void PopupUtils.getConfigParameterLocal([PopupUtils.StorageParamNameAccounts,PopupUtils.StorageParamNameOrgs,PopupUtils.StorageParamNameShortcuts,PopupUtils.StorageParamNamePopupStatus,PopupUtils.StorageParamNameLastVersionInstalled,PopupUtils.StorageParamNameAccountGroupSorted,PopupUtils.StorageParamNameAccountsOnGroupSorted,PopupUtils.StorageParamNamePin,PopupUtils.StorageParamNameFavoriteLogins],function(err,params){return err?callback&&callback(err):(params||(params={}),returnObject.storedParamsAccounts=params[PopupUtils.StorageParamNameAccounts]||[],returnObject.storedParamsOrgs=params[PopupUtils.StorageParamNameOrgs]||[],returnObject.shortcuts=params[PopupUtils.StorageParamNameShortcuts]||PopupUtils.DefaultShortcuts,returnObject.popupInitStatus=params[PopupUtils.StorageParamNamePopupStatus]||{},returnObject.showAlertChangeLog=!!params[PopupUtils.StorageParamNameLastVersionInstalled],returnObject.storedOrderedGroups=params[PopupUtils.StorageParamNameAccountGroupSorted],returnObject.storedOrderedAccountsOnGroups=params[PopupUtils.StorageParamNameAccountsOnGroupSorted],returnObject.pinConfiguration=params[PopupUtils.StorageParamNamePin]||null,returnObject.filterFavoriteLogins=params[PopupUtils.StorageParamNameFavoriteLogins]||!1,callback&&callback(null,returnObject))}))})},mergeSyncedData:function(decryptedLocalAccounts,localParamOrgs,callback){return PopupUtils.setupFromSync(function(err,params){var returnObject={};if(err)return PopupUtils.logError("mergeSyncedData:"+err),callback&&callback(chrome.i18n.getMessage("popup_general_unpexpected_error")+err);var accounts=params[PopupUtils.StorageParamNameAccounts],orgs=params[PopupUtils.StorageParamNameOrgs],otherParameters=params.otherParameters||{};returnObject.shortcuts=otherParameters[PopupUtils.StorageParamNameShortcuts]||PopupUtils.DefaultShortcuts,returnObject.apiLevel=otherParameters[PopupUtils.StorageParamNameApiLevel]||$C.SF_API.LEVEL;for(var promoCodes=otherParameters[PopupUtils.StorageParamNamePromoCodes]||[],s=0;s<accounts.length;s++){for(var found=!1,i=0;i<decryptedLocalAccounts.length;i++)if(accounts[s].u===decryptedLocalAccounts[i].u){decryptedLocalAccounts.splice(i,1,accounts[s]),found=!0;break}found||decryptedLocalAccounts.push(accounts[s])}for(var i=0;i<decryptedLocalAccounts.length;i++)if(decryptedLocalAccounts[i].s){for(var found=!1,s=0;s<accounts.length;s++)accounts[s].u===decryptedLocalAccounts[i].u&&(found=!0);found||decryptedLocalAccounts.splice(i,1)}for(var s=0;s<orgs.length;s++){for(var found=!1,i=0;i<localParamOrgs.length;i++)if(orgs[s].oid===localParamOrgs[i].oid||PopupUtils.isMyDomain(orgs[s].n)&&orgs[s].n.toUpperCase()===localParamOrgs[i].n.toUpperCase()){orgs[s].d&&localParamOrgs[i].d&&orgs[s].d<localParamOrgs[i].d?(orgs[s].d=localParamOrgs[i].d,orgs[s].oid=localParamOrgs[i].oid,orgs[s].n=localParamOrgs[i].n.toUpperCase()):orgs[s].d&&orgs[s].oid!==localParamOrgs[i].oid&&orgs[s].d>localParamOrgs[i].d&&PopupUtils.switchOrgRelatedLocalData({oldOrgId:localParamOrgs[i].oid,newOrgId:orgs[s].oid},function(err){console.error("Error in updating local org vs remote org local storage with new incoming id",err)}),orgs[s].d||(orgs[s].d=localParamOrgs[i].d?localParamOrgs[i].d:(new Date).getTime()),localParamOrgs.splice(i,1,orgs[s]),found=!0;break}found||localParamOrgs.push(orgs[s])}PopupUtils.setConfigParameterLocal(PopupUtils.StorageParamNameAccounts,decryptedLocalAccounts,function(err){return err?(PopupUtils.logError(err),callback&&callback(chrome.i18n.getMessage("popup_general_unpexpected_error")+err+" ["+PopupUtils.StorageParamNameAccounts+"]")):void PopupUtils.setConfigParameterLocal(PopupUtils.StorageParamNameOrgs,localParamOrgs,function(err){return err?(PopupUtils.logError(err),callback&&callback(chrome.i18n.getMessage("popup_general_unpexpected_error")+err+" ["+PopupUtils.StorageParamNameOrgs+"]")):void PopupUtils.setConfigParameterLocal(PopupUtils.StorageParamNameApiLevel,returnObject.apiLevel,function(err){return err?(PopupUtils.logError(err),callback&&callback(chrome.i18n.getMessage("popup_general_unpexpected_error")+err+" ["+PopupUtils.StorageParamNameApiLevel+"]")):void PopupUtils.setConfigParameterLocal(PopupUtils.StorageParamNamePromoCodes,promoCodes,function(err){return err?(PopupUtils.logError(err),callback&&callback(chrome.i18n.getMessage("popup_general_unpexpected_error")+err+" ["+PopupUtils.StorageParamNameShortcuts+"]")):void PopupUtils.setConfigParameterLocal(PopupUtils.StorageParamNameShortcuts,returnObject.shortcuts,function(err){return err?(PopupUtils.logError(err),callback&&callback(chrome.i18n.getMessage("popup_general_unpexpected_error")+err+" ["+PopupUtils.StorageParamNameShortcuts+"]")):callback&&callback(null,returnObject)})})})})})})},syncFromSyncStorage:function(disableInterfaceFn,handlePasswordRequestFn,callback){return PopupUtils.loadLocalMainData(function(err,localParams){var currentPassword=localParams.storedPassPhrase;if(err)return callback&&callback(err);var localAccounts=localParams.storedParamsAccounts,localParamOrgs=localParams.storedParamsOrgs,pinConfiguration=localParams.pinConfiguration;PopupUtils.getSyncPassphrase(function(err,remoteMD5,version){if(err)return callback&&callback(chrome.i18n.getMessage("popup_general_unpexpected_error_on_sync")+": "+err);if(remoteMD5){if(remoteMD5){var oldStoredPassPhrase=currentPassword;PopupUtils.pinExpired(pinConfiguration)&&(currentPassword=null);var localMD5=PopupUtils.getPasswordHashInverse(remoteMD5,currentPassword,version);if(currentPassword&&(localMD5===currentPassword||!version&&localMD5===remoteMD5))return PopupUtils.mergeSyncedData(localAccounts,localParamOrgs,callback);handlePasswordRequestFn(chrome.i18n.getMessage("popup_password_request_modal_title"),function(result,newPwd){if(!result||!newPwd)return setTimeout(function(){disableInterfaceFn(chrome.i18n.getMessage("popup_freeze_wrong_password_message"))},100),callback&&callback(chrome.i18n.getMessage("popup_password_request_modal_message"));var newPwdMD5=PopupUtils.getPasswordHashInverse(remoteMD5,newPwd,version);if(version&&newPwdMD5!==newPwd||!version&&newPwdMD5!==remoteMD5)return setTimeout(function(){disableInterfaceFn(chrome.i18n.getMessage("popup_reload_ext_provide_password"))},100),callback&&callback(chrome.i18n.getMessage("popup_invalid_password_message"));PopupUtils.pinExpired(pinConfiguration)&&(currentPassword=newPwd);for(var accounts=JSON.parse(JSON.stringify(localAccounts)),i=0;i<accounts.length;i++){if(oldStoredPassPhrase)accounts[i].p=PopupUtils.decryptText(accounts[i].p,oldStoredPassPhrase);else{var tmp=accounts[i].p;try{accounts[i].p=PopupUtils.deobfuscate(accounts[i].p)}catch(ex){accounts[i].p=null}accounts[i].p||(accounts[i].p=tmp)}accounts[i].p=PopupUtils.encryptText(accounts[i].p,newPwd)}PopupUtils.setLocalPassphrase(newPwd,function(err){return err?callback&&callback(err):(PopupUtils.pinExpired(pinConfiguration)&&PopupUtils.updatePinLastCheck(pinConfiguration),PopupUtils.mergeSyncedData(accounts,localParamOrgs,callback))})})}}else{for(var accounts=JSON.parse(JSON.stringify(localAccounts)),i=0;i<accounts.length;i++){if(currentPassword)accounts[i].p=PopupUtils.decryptText(accounts[i].p,currentPassword);else{var tmp=accounts[i].p;try{accounts[i].p=PopupUtils.deobfuscate(accounts[i].p);
}catch(ex){accounts[i].p=null}accounts[i].p||(accounts[i].p=tmp)}accounts[i].p=PopupUtils.obfuscate(accounts[i].p)}PopupUtils.setLocalPassphrase(null,function(err){return err?callback&&callback(chrome.i18n.getMessage("popup_general_unpexpected_error")+": "+err):PopupUtils.mergeSyncedData(accounts,localParamOrgs,callback)})}})})},getLocalCode:function(callback){PopupUtils.getConfigParameterLocal([PopupUtils.StorageParamNameUnCode],function(err,params){var uc=params[PopupUtils.StorageParamNameUnCode];if(!uc){var rnd=""+Math.random();return uc=PopupUtils.obfuscate(rnd),PopupUtils.setConfigParameterLocal(PopupUtils.StorageParamNameUnCode,uc,function(err){return callback&&callback(rnd)})}return uc=PopupUtils.deobfuscate(uc),callback&&callback(uc)})},checkPromoCodeDigits:function(code){return $C.PromoCodes.CUSTOM_REGEX.test(code||"")||$C.PromoCodes.GUMROAD_REGEX.test(code||"")},getPromoCodeType:function(code){return $C.PromoCodes.GUMROAD_REGEX.test(code||"")?$C.PromoCodes.GUMROAD_PROMO_TYPE:$C.PromoCodes.CUSTOM_PROMO_TYPE},isRunningContent:function(){return $G.isRunningContent()},ajaxCall:function(options){PopupUtils.isRunningContent()&&$G.isChrome?chrome.runtime.sendMessage({action:"BKG-DO-AJAX-CALL",options:options}):$.ajax(options)},loadAjaxCache:function(callback){PopupUtils.getLocalCode(function(uc){PopupUtils.getConfigParameterLocal([PopupUtils.StorageParamNameAjaxCache],function(err,params){var cache=(params||{})[PopupUtils.StorageParamNameAjaxCache]||null;if(!cache)return callback&&callback({});try{var unzippedCache=LZString.decompressFromEncodedURIComponent(cache),cache=PopupUtils.deobfuscate(unzippedCache);return cache=JSON.parse(cache),cache.uc!==uc?callback&&callback({}):callback&&callback(cache)}catch(ex){debug.error("Error getting cache from storage:",ex)}return callback&&callback({})})})},storeAjaxCache:function(cacheObj,callback){PopupUtils.getLocalCode(function(uc){cacheObj=cacheObj||null,cacheObj&&(cacheObj.uc=uc,cacheObj=JSON.stringify(cacheObj),cacheObj=PopupUtils.obfuscate(cacheObj),cacheObj=LZString.compressToEncodedURIComponent(cacheObj)),PopupUtils.setConfigParameterLocal(PopupUtils.StorageParamNameAjaxCache,cacheObj,function(err,params){return callback&&callback(err,cacheObj)})})},getLocalIPs:function(callback){var ips=[],RTCPeerConnection=window.RTCPeerConnection||window.webkitRTCPeerConnection||window.mozRTCPeerConnection,pc=new RTCPeerConnection({iceServers:[]});pc.createDataChannel(""),pc.onicecandidate=function(e){if(!e.candidate)return pc.close(),callback&&callback(ips.join("!"));var ip=/^candidate:.+ (\S+) \d+ typ/.exec(e.candidate.candidate)[1];ips.indexOf(ip)==-1&&ips.push(ip)},pc.createOffer(function(sdp){pc.setLocalDescription(sdp)},function(){})},getFFActivatedProducts:function(callback){return $G.isChrome?callback&&callback(new Error("Operation invalid for Chrome [1]")):void PopupUtils.getLocalCode(function(code){PopupUtils.getConfigParameterLocal(PopupUtils.StorageParamNameFFProducts,function(err,params){var activationData=(params||{})[PopupUtils.StorageParamNameFFProducts];if(!activationData)return callback&&callback();try{activationData=LZString.decompressFromEncodedURIComponent(activationData),activationData=PopupUtils.decryptText(activationData,code),activationData=JSON.parse(activationData);for(var ip=0;ip<activationData.products.length;ip++){var promoDetails=activationData.products[ip],isExpired=new Date(promoDetails.expiration)<=new Date;promoDetails.state=isExpired?"EXPIRED":"ACTIVE"}}catch(ex){debug.error("ActivationData error:",ex),activationData=null}return debug.log("activationData",activationData,code),activationData?activationData.uc!==code?PopupUtils.setConfigParameterLocal(PopupUtils.StorageParamNameFFProducts,null,function(){return callback&&callback(new Error("Activation data corrupted. Please reactivate again [2]"))}):callback&&callback(null,activationData):PopupUtils.setConfigParameterLocal(PopupUtils.StorageParamNameFFProducts,null,function(){return callback&&callback(new Error("Activation data corrupted. Please reactivate again [1]"))})})})},decryptLocalAccounts:function(pwd,callback){PopupUtils.getConfigParameterLocal([PopupUtils.StorageParamNameAccounts],function(err,params){if(err)return PopupUtils.logError(err),callback&&callback(err);params||(params={});for(var _storedParamsAccounts=JSON.parse(JSON.stringify(params[PopupUtils.StorageParamNameAccounts]||[])),i=0;i<_storedParamsAccounts.length;i++)if(pwd)_storedParamsAccounts[i].p=PopupUtils.decryptText(_storedParamsAccounts[i].p,pwd);else{var tmp=_storedParamsAccounts[i].p;_storedParamsAccounts[i].p=PopupUtils.deobfuscate(_storedParamsAccounts[i].p),_storedParamsAccounts[i].p||(_storedParamsAccounts[i].p=tmp)}return callback&&callback(null,_storedParamsAccounts)})},sortLoginsHandler:function(a,b,sortedGroups,sortedLoginOnGroups){if(sortedGroups.indexOf(a.g)>=0||sortedGroups.indexOf(b.g)>=0){if(sortedGroups.indexOf(a.g)<0)return 1;if(sortedGroups.indexOf(b.g)<0)return-1;if(sortedGroups.indexOf(a.g)>sortedGroups.indexOf(b.g))return 1;if(sortedGroups.indexOf(a.g)<sortedGroups.indexOf(b.g))return-1}else{if(a.g.toUpperCase()>b.g.toUpperCase())return 1;if(a.g.toUpperCase()<b.g.toUpperCase())return-1}if(a.g===b.g){var groupSorting=sortedLoginOnGroups[a.g];if(groupSorting){if(groupSorting.indexOf(a.u)>groupSorting.indexOf(b.u))return 1;if(groupSorting.indexOf(a.u)<groupSorting.indexOf(b.u))return-1}if(a.u>b.u)return 1;if(a.u<b.u)return 1;if(!a.n)return-1;if(!b.n)return 1;if(a.n>b.n)return 1;if(a.n<b.n)return 1}return 0},encryptForSalesforce:function(msg,base64Secret){var iv=CryptoJS.lib.WordArray.random(16),aes_options={mode:CryptoJS.mode.CBC,padding:CryptoJS.pad.Pkcs7,iv:iv},encryptionObj=CryptoJS.AES.encrypt(msg,CryptoJS.enc.Base64.parse(base64Secret),aes_options),encryptedBuffer=$G.base64ToArrayBuffer(encryptionObj.toString()),ivBuffer=$G.base64ToArrayBuffer(encryptionObj.iv.toString(CryptoJS.enc.Base64)),finalBuffer=$G.appendBuffer(ivBuffer,encryptedBuffer);return $G.arrayBufferToBase64(finalBuffer)},decryptFromSalesforce:function(encryptedBase64,base64Secret){var arrayBuffer=$G.base64ToArrayBuffer(encryptedBase64),iv=CryptoJS.enc.Base64.parse($G.arrayBufferToBase64(arrayBuffer.slice(0,16))),encryptedStr=$G.arrayBufferToBase64(arrayBuffer.slice(16,arrayBuffer.byteLength)),aes_options={iv:iv,mode:CryptoJS.mode.CBC},decryptObj=CryptoJS.AES.decrypt(encryptedStr,CryptoJS.enc.Base64.parse(base64Secret),aes_options);return decryptObj.toString(CryptoJS.enc.Utf8)},getAnalyticsEventTrackingInfo:function(category,action){if(!category||!action)return null;for(var cKey in $C.Analytics.EVENTS)if(category===$C.Analytics.EVENTS[cKey].name){for(var aKey in $C.Analytics.EVENTS[cKey].Actions)if(action===$C.Analytics.EVENTS[cKey].Actions[aKey].name)return $C.Analytics.EVENTS[cKey].Actions[aKey];break}return null},isMyDomain:function(currentDomain){for(var isMyDomainTmp=!1,ii=0;ii<PopupUtils.OrgInstancesRegExpList.length;ii++){var instanceRegEx=PopupUtils.OrgInstancesRegExpList[ii];if(instanceRegEx.test((currentDomain||"").trim())){isMyDomainTmp=!1;break}isMyDomainTmp=!0}return isMyDomainTmp},switchOrgRelatedLocalData:function(params,callback){if(debug.log("Switching orgs local storage...",params),params=params||{},callback=callback||function(){},!params.newOrgId||!params.oldOrgId)return callback&&callback(new Error("Missing org ids ("+params.newOrgId+","+params.oldOrgId+")"));var availablePluginsWithStorage=[$C.Plugins.$SFORG_PLUGIN_CHANGE_SET,$C.Plugins.$SFORG_PLUGIN_PROFILE_CHAMBER,$C.Plugins.$SFORG_PLUGIN_00001,$C.Plugins.$SFORG_PLUGIN_00002,$C.Plugins.$SFORG_PLUGIN_00003],pluginResetFn=[],removePluginStorage=function(oldOgId){return function(err){return debug.log("Deleting plugin storage: ",oldOgId,err),PopupUtils.deletePluginStorage(oldOgId,function(err){return pluginResetFn.pop()(err)})}},replacePluginStorage=function(pluginId,oldId,newId){return function(err){return debug.log("Switching plugin: ",pluginId,err),PopupUtils.getPluginStorage(pluginId,oldId,function(err,oldData){return err?pluginResetFn.pop()(err):PopupUtils.setPluginStorage(pluginId,newId,oldData,function(err,newData){return pluginResetFn.pop()(err)})})}},replaceQuickLinksHistory=function(oldOrgId,newOrgId){return function(err){debug.log("Switching Quicklink History...",err),PopupUtils.getConfigParameterLocal(PopupUtils.StorageParamNameQuickLinkHistory,function(err,params){if(err)return pluginResetFn.pop()(err);var _storedParamsOrgs=(params||{})[PopupUtils.StorageParamNameQuickLinkHistory]||{},orgParams=_storedParamsOrgs[oldOrgId];return orgParams?(_storedParamsOrgs[newOrgId]=orgParams,_storedParamsOrgs[oldOrgId]=void 0,void PopupUtils.setConfigParameterLocal(PopupUtils.StorageParamNameQuickLinkHistory,_storedParamsOrgs,function(err,data){return pluginResetFn.pop()(err)})):pluginResetFn.pop()()})}};pluginResetFn.push(callback),pluginResetFn.push(removePluginStorage(params.oldOrgId));for(var pi=0;pi<availablePluginsWithStorage.length;pi++){var pluginId=availablePluginsWithStorage[pi];pluginResetFn.push(replacePluginStorage(pluginId,params.oldOrgId,params.newOrgId))}pluginResetFn.push(replaceQuickLinksHistory(params.oldOrgId,params.newOrgId)),pluginResetFn.pop()()},exportManualBackup:function(options,callback){return options=options||{},PopupUtils.getConfigParameterLocal([PopupUtils.StorageParamNameAccounts,PopupUtils.StorageParamNameOrgs],function(err,params){if(err)return PopupUtils.logError(err),callback&&callback(err);params||(params={});var _storedParamsAccounts=params[PopupUtils.StorageParamNameAccounts]||[],_storedParamsOrgs=params[PopupUtils.StorageParamNameOrgs]||[],exportObj={};exportObj[PopupUtils.StorageParamNameAccounts]=JSON.parse(JSON.stringify(_storedParamsAccounts)),exportObj[PopupUtils.StorageParamNameOrgs]=JSON.parse(JSON.stringify(_storedParamsOrgs));for(var i=0;i<exportObj[PopupUtils.StorageParamNameAccounts].length;i++)if(options.localPassPhrase)exportObj[PopupUtils.StorageParamNameAccounts][i].p=PopupUtils.decryptText(exportObj[PopupUtils.StorageParamNameAccounts][i].p,options.localPassPhrase);else{var tmp=exportObj[PopupUtils.StorageParamNameAccounts][i].p;exportObj[PopupUtils.StorageParamNameAccounts][i].p=PopupUtils.deobfuscate(exportObj[PopupUtils.StorageParamNameAccounts][i].p),exportObj[PopupUtils.StorageParamNameAccounts][i].p||(exportObj[PopupUtils.StorageParamNameAccounts][i].p=tmp)}for(var i=0;i<exportObj[PopupUtils.StorageParamNameOrgs].length;i++){var org=exportObj[PopupUtils.StorageParamNameOrgs][i];org.ql=JSON.parse(org.ql)}var backupBody=JSON.stringify(exportObj,null,2),contentType="text/json",extension=".json";return options.handleCompression&&(contentType="application/octet",extension=".bkp",backupBody=options.backupPassPhrase?PopupUtils.encryptText(backupBody,options.backupPassPhrase):options.localPassPhrase?PopupUtils.encryptText(backupBody,options.localPassPhrase):PopupUtils.obfuscate(backupBody),backupBody=LZString.compressToEncodedURIComponent(backupBody)),options.returnBackupContent?callback&&callback(null,backupBody):PopupUtils.triggerDownloadTextFile("backup_"+(new Date).getTime()+extension,contentType,backupBody,callback)})},importManualBackup:function(options,callback){options=options||{},debug.log("Import options:",options);var tmp=options.backupContent;try{options.handleCompression&&(tmp=LZString.decompressFromEncodedURIComponent(options.backupContent),tmp=options.backupPassPhrase?PopupUtils.decryptText(tmp,options.backupPassPhrase):options.localPassPhrase?PopupUtils.decryptText(tmp,options.localPassPhrase):PopupUtils.deobfuscate(tmp)),tmp=JSON.parse(tmp)}catch(ex){PopupUtils.logError(ex)}if(!tmp||!tmp instanceof Object)return callback&&callback("Invalid format [not an JSON format]");var accounts=tmp[PopupUtils.StorageParamNameAccounts],orgs=tmp[PopupUtils.StorageParamNameOrgs];if(accounts&&!accounts instanceof Array)return callback&&callback("Invalid format for "+PopupUtils.StorageParamNameAccounts+" field [not an array]");if(accounts||(accounts=[]),orgs&&!orgs instanceof Array)return callback&&callback("Invalid format for "+PopupUtils.StorageParamNameOrgs+" field [not an array]");orgs||(orgs=[]);for(var newAccounts=[],i=0;i<accounts.length;i++){if(!(accounts[i]&&accounts[i]instanceof Object))return callback&&callback("Invalid format on "+PopupUtils.StorageParamNameAccounts+" item "+(i+1));if(!accounts[i].u||!accounts[i].p&&!accounts[i].lo||!accounts[i].r&&0!=accounts[i].r)return callback&&callback("Missing mandatory fields on "+PopupUtils.StorageParamNameAccounts+" item "+(i+1));var item={u:accounts[i].u,n:accounts[i].n,r:accounts[i].r,p:accounts[i].p,g:accounts[i].g,t:accounts[i].t,lp:accounts[i].lp,lt:!!accounts[i].lt,lo:!!accounts[i].lo,s:accounts[i].s||!1,f:accounts[i].f||!1,d:(new Date).getTime()};!Number.isInteger(parseInt(item.r))&&PopupUtils.StandardLoginURLs.indexOf(item.r)>=0&&(item.r=PopupUtils.StandardLoginURLs.indexOf(item.r)),!Number.isInteger(parseInt(item.lp))&&PopupUtils.StandardLandingPages.indexOf(item.lp)>=0&&(item.lp=PopupUtils.StandardLandingPages.indexOf(item.lp)),options.localPassPhrase?item.p=PopupUtils.encryptText(item.p,options.localPassPhrase):item.p=PopupUtils.obfuscate(item.p),newAccounts.push(item)}for(var newOrgs=[],i=0;i<orgs.length;i++){if(!(orgs[i]&&orgs[i]instanceof Object))return callback&&callback("Invalid format on "+PopupUtils.StorageParamNameOrgs+" item "+(i+1));if(!orgs[i].oid||!orgs[i].n)return callback&&callback("Missing mandatory "+PopupUtils.StorageParamNameOrgs+" fields on item "+(i+1)+" "+JSON.stringify(orgs[i]));if(orgs[i].ql&&!Array.isArray(orgs[i].ql))return callback&&callback('Invalid array "ql" field on item '+(i+1));for(var qi=0;qi<orgs[i].ql.length;qi++){var ql=orgs[i].ql[qi];if(!(ql&&ql instanceof Object&&ql.l&&ql.p))return callback&&callback("Invalid quick link item ("+(qi+1)+') on "ql" field on item '+(i+1))}var item={n:orgs[i].n,oid:orgs[i].oid,l:orgs[i].l,c:orgs[i].c,d:orgs[i].d||(new Date).getTime(),ql:JSON.stringify(orgs[i].ql||[])};newOrgs.push(item)}PopupUtils.checkLocalQuota(newAccounts,function(err){return err?(PopupUtils.logError(err),callback&&callback(err)):void PopupUtils.setConfigParameterLocal(PopupUtils.StorageParamNameAccounts,newAccounts,function(err){return err?(PopupUtils.logError(err),callback&&callback(err)):void PopupUtils.setConfigParameterLocal(PopupUtils.StorageParamNameOrgs,newOrgs,function(err){return err?(PopupUtils.logError(err),callback&&callback(err)):void PopupUtils.syncData({},function(err){return err?(PopupUtils.logError(err),callback&&callback(err)):callback&&callback()})})})})},escapeXML:function(value){var XML_CHAR_MAP={"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;","'":"&apos;"};return value=value||"",value.replace(/[<>&"']/g,function(ch){return XML_CHAR_MAP[ch]})}};return debug=PopupUtils.newDebugger("PopupUtils"),PopupUtils}),global.true=exports}({},function(){return this}());