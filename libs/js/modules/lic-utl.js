/* [DEV] ORGanizer for Salesforce - v10000.0.9.11 
 * Author:  (https://organizer.solutions/)
 * Copyright 2021
 */
!function(exports,global){define("licensing-utils",["global","constants","jquery","popup-utils","salesforce-client","lz-string"],function($G,$C,$,PopupUtils,$SalesforceClient,LZString){"use sctrict";const chrome=$G.chrome,window=$G.window,debug=PopupUtils.newDebugger("ORGanizer: LicUtl"),DEFAULT_VALUES={ActionsCounterDefault:{popup:0,console:0,lastEvent:(new Date).getTime(),lastHit:(new Date).getTime()}},LicensingUtils={getActionsCounterFromStorage:function(callback){PopupUtils.getConfigParameterLocal([PopupUtils.StorageParamNameActionsCounter],function(err,params){if(err)return callback&&callback(err);var cache=(params||{})[PopupUtils.StorageParamNameActionsCounter]||null;if(!cache)return callback&&callback(null,DEFAULT_VALUES.ActionsCounterDefault);try{var unzippedCache=LZString.decompressFromEncodedURIComponent(cache),actionsCounter=PopupUtils.deobfuscate(unzippedCache);return actionsCounter=JSON.parse(actionsCounter),callback&&callback(null,actionsCounter)}catch(ex){return PopupUtils.logError(ex),callback&&callback("Unable to parse counter: "+ex)}})},saveActionsCounterToStorage:function(actionsCounter,callback){actionsCounter||(debug.log("Empty actionsCounter"),actionsCounter=DEFAULT_VALUES.ActionsCounterDefault);try{var cache=PopupUtils.obfuscate(JSON.stringify(actionsCounter));return cache=LZString.compressToEncodedURIComponent(cache),PopupUtils.setConfigParameterLocal(PopupUtils.StorageParamNameActionsCounter,cache,callback)}catch(ex){return PopupUtils.logError(ex),callback&&callback("Unable to encode counter: "+ex)}},checkActionsCounterThreshold:function(actionsCounter){return!!actionsCounter&&((actionsCounter.console>=$C.ActionsThold.Console||actionsCounter.popup>=$C.ActionsThold.Popup)&&(!actionsCounter.lastHit||actionsCounter.lastHit<(new Date).getTime()-($C.ActionsCounterTimeThreashold||864e6)))},handleActionsCounterIncrement:function(params,callback){return params?void PopupUtils.getLicenseLimits(function(err,limits){return debug.log("handleActionsCounterIncrement: ",limits),LicensingUtils.checkLicenseLimits(limits)?LicensingUtils.getActionsCounterFromStorage(function(err,actionsCounter){if(err)return callback&&callback(err);debug.log("Events: ",params);var trackingInfo=PopupUtils.getAnalyticsEventTrackingInfo(params.eventCategory,params.eventAction);if((params.eventCategory===$C.Analytics.EVENTS.QUICKCONSOLE_ACTION.name||params.eventCategory===$C.Analytics.EVENTS.CONTENT_ACTION.name)&&trackingInfo&&trackingInfo.trackActions)actionsCounter.console++,actionsCounter.lastEvent=(new Date).getTime();else{if(params.eventCategory!==$C.Analytics.EVENTS.POPUP_ACTION.name||!trackingInfo||!trackingInfo.trackActions)return callback&&callback();actionsCounter.popup++,actionsCounter.lastEvent=(new Date).getTime()}debug.log("Hits: ",params,actionsCounter,$C.ActionsThold);var hit=LicensingUtils.checkActionsCounterThreshold(actionsCounter);return LicensingUtils.saveActionsCounterToStorage(actionsCounter,function(err){return hit&&(PopupUtils.trackAnalyticsEvent($C.Analytics.EVENTS.BACKGROUND_ACTION.Actions.ACTIONS_LIMIT_HIT.name,$C.Analytics.EVENTS.BACKGROUND_ACTION.name),chrome.tabs.query({},function(tabs){for(var i=0;i<tabs.length;++i)chrome.tabs.sendMessage(tabs[i].id,{action:"CNT-ACTIONS-LIMIT-CHANGE",actionsLimitHit:hit},function(response){})})),callback&&callback(err)})}):callback&&callback()}):callback&&callback("No params sent to handleActionsCounterIncrement()")},checkActionsCounterHit:function(callback){LicensingUtils.getActionsCounterFromStorage(function(err,actionsCounter){if(err)return callback&&callback(err);var hit=LicensingUtils.checkActionsCounterThreshold(actionsCounter);return callback&&callback(err,hit)})},resetActionsCounter:function(callback){var actionsCounter=JSON.parse(JSON.stringify(DEFAULT_VALUES.ActionsCounterDefault));LicensingUtils.saveActionsCounterToStorage(actionsCounter,function(err){chrome.tabs.query({},function(tabs){for(var i=0;i<tabs.length;++i)chrome.tabs.sendMessage(tabs[i].id,{action:"CNT-ACTIONS-LIMIT-CHANGE",actionsLimitHit:!1},function(response){});return callback&&callback(err)})})},createOverlayContent:function(callback){var link=$('<div><div class="ui-pointer ui-overlay-defrost-link" id="_unfreezeFull"><strong>To unfreeze the ORGanizer, click here to jump to the ORGanizer site!</strong><br/><small>After your click, the extension will keep working as usual! Thank you for you support and help to support the development with just a click!</small><br/><br/><small>If you don\'t want to see this anymore, purchase a license.</small></div><br/><br/><div id="_unfreezeTemp" class="ui-pointer"><strong>Click here to close this panel and keep using the ORGanizer...</strong></div></div>');return link.find("#_unfreezeFull").click(callback),link.find("#_unfreezeTemp").click(function(){link.parent().parent().hide()}),link},createQuickLinkOverlayItem:function(){return{l:"[_b_]To unfreeze Quick Links, click here to jump to the ORGanizer site![_/b_]",p:"Help support the development with just a click!",isCustom:!0,openSameWindow:!1,isAd:!0}},checkLicenseLimits:function(license){return!license||(license.ENABLE_ACTIONS_LIMIT_FREEZE||!1)},getOverlayAction:function(){var promise=chrome.runtime.sendMessage({action:"BKG-DEFROST-UI"});$G.isFirefox&&promise&&promise.then(function(){}),setTimeout(function(){window.open($C.Endpoints.ActionsLimitLandingPage)},200)},validatePromoCode:function(code,callback){var getProfileInfo=function(callback){LicensingUtils.checkCustomAuthEnabled(function(enabled){return enabled||!$G.isEdge&&!$G.isChrome?LicensingUtils.handleOAuthWebFlow(!1,function(err,profileInfo){return callback&&callback(err,profileInfo)}):chrome.identity.getProfileUserInfo(function(profile){return callback&&callback(chrome.runtime.lastError,profile)})})};return getProfileInfo(function(err,profile){if(debug.log("Profile: ",profile),!profile||!profile.email){var err=new Error("Cannot get user's email address: user not logged?");return err.unauthenticated=!0,callback&&callback(err)}var userEmail=profile.email.toLowerCase();PopupUtils.getLocalCode(function(uc){var url=$C.Endpoints.PromoCodeValidationEndpoint;url.indexOf("@@")>=0&&(url=$C.Endpoints.PromoCodeValidationEndpoint_DEV),url+="/"+code;var authHeader="CHROME_BEARER "+PopupUtils.obfuscate(userEmail+"|"+uc);debug.log("validatePromoCode.url: ",url);var options={type:"GET",cache:!0,url:url,headers:{Authorization:authHeader},success:function(data,textStatus,request){if(data=data||"",debug.log("validatePromoCode",data),!data)return callback&&callback(new Error("No data from server. Retry."));try{var decryptedMsg=PopupUtils.decryptText(data,userEmail),splitInfo=decryptedMsg.split("|");if(debug.log("splitInfo:",splitInfo),splitInfo.length<4)throw new Error("Invalid number of params.");var decryptedEmail=splitInfo[3].toLowerCase();if(decryptedEmail!==userEmail){var lastError=new Error("Mismatching email address: "+userEmail);throw lastError.validationError=!0,lastError}var expirationDate=splitInfo[1];if(!expirationDate||"Invalid Date"==new Date(expirationDate))throw new Error("Invalid expiration date: "+expirationDate);return callback&&callback(null,{code:splitInfo[0],expirationDate:expirationDate,productSku:splitInfo[2],manageUrl:splitInfo.length>4?splitInfo[4]:null})}catch(ex){debug.log(ex);var lastError=new Error("Cannot validate promo code. ["+PopupUtils.encryptText(ex+"",userEmail)+"]");return lastError.validationError=ex.validationError,callback&&callback(lastError)}},error:function(response,textStatus,errorThrown){if(debug.log("validatePromoCode",textStatus,errorThrown),!response||404!==response.status&&403!==response.status&&401!==response.status){if(!response||500!==response.status&&501===response.status)return response&&response.responseText?callback&&callback(new Error("Server not ready. Please retry. If error persists contact support. [Details: "+response.responseText+" ( "+textStatus+" ,"+response.status+")")):callback&&callback("Unexpected error: "+errorThrown);var lastError=new Error("Server not ready. Please retry. If error persists contact support. [Details: "+response.status+" : "+response.responseText+"]");return lastError.nonBloking=!0,callback&&callback(lastError)}var lastError=new Error("Not found, expired or not authorized");return lastError.notFound=!0,callback&&callback(lastError)}};PopupUtils.ajaxCall(options)})})},checkCustomAuthEnabled:function(callback){return chrome.storage.local.get([PopupUtils.StorageParamNameCustomAuthFlow],function(params){return params=params||{},debug.log($G.isFirefox,$G.isOpera,params[PopupUtils.StorageParamNameCustomAuthFlow]),callback&&callback($G.isFirefox||$G.isOpera||params[PopupUtils.StorageParamNameCustomAuthFlow]||!1)})},createWebAuthFlowUrl:function(){var redirectURL=chrome.identity.getRedirectURL(),clientID=$C.OAuthSettings.ClientId;clientID.indexOf("@@")>=0&&(clientID=$C.OAuthSettings.ClientId_DEV);var scopes=$C.OAuthSettings.Scopes,authURL=$C.Endpoints.GoogleOAuthUrl;return authURL+="?client_id="+encodeURIComponent(clientID),authURL+="&response_type=code",authURL+="&redirect_uri="+encodeURIComponent(redirectURL),authURL+="&scope="+encodeURIComponent(scopes.join(" ")),authURL+="&access_type=offline",authURL+="&prompt=consent"},getQueryStringParams:function(query){return query?(/^[?#]/.test(query)?query.slice(1):query).split("&").reduce(function(params,param){var paramSplit=param.split("="),key=paramSplit[0],value=paramSplit.length>1?paramSplit[1]:null;return params[key]=value?decodeURIComponent(value.replace(/\+/g," ")):"",params},{}):{}},parseWebFlowUrl:function(url){var authUrl=new URL(url);debug.log("Response: ",authUrl);for(var queryParams=LicensingUtils.getQueryStringParams(authUrl.search||""),hashArray=(authUrl.hash||"").substring(1).split("&"),hashMap={},hi=0;hi<hashArray.length;hi++){var tmp=hashArray[hi].split("=");tmp.length>1&&(hashMap[tmp[0]]=decodeURIComponent(tmp[1]))}return{hashMap:hashMap,queryParams:queryParams}},getAuthorizationCode:function(options,callback){return PopupUtils.getLocalCode(function(uc){var tokenEndpoint=$C.Endpoints.OAuthTokenUrl;tokenEndpoint.indexOf("@@")>=0&&(tokenEndpoint=$C.Endpoints.OAuthTokenUrl_DEV);var bearer="CHROME_BEARER "+PopupUtils.obfuscate(chrome.runtime.id+"|"+uc),body={client_id:options.client_id,redirect_uri:options.redirect_uri,code:options.code||null,refresh_token:options.refresh_token||null,grant_type:options.grant_type};return debug.log("options",options,body),$.ajax({type:"POST",cache:!1,url:tokenEndpoint,cache:!1,headers:{"content-type":"application/json",authorization:bearer},data:JSON.stringify(body),success:function(data,textStatus,response){debug.log("getAuthorizationCode: success(): ",response.status,data);try{data=JSON.parse(data)}catch(ex){}return 200!==response.status?callback&&callback(data):callback&&callback(null,data)},error:function(response,textStatus,errorThrown){return console.log("getAuthorizationCode: error(): ",response.status,textStatus,errorThrown),response&&response.responseText?callback&&callback(new Error("Unexpected error: "+response.responseText+" "+response.status)):callback&&callback(new Error("Unexpected error: "+errorThrown+" "+textStatus))}})})},refreshToken:function(interactive,callback){var clientID=$C.OAuthSettings.ClientId;return clientID.indexOf("@@")>=0&&(clientID=$C.OAuthSettings.ClientId_DEV),LicensingUtils.getOAuthTokens(function(err,tokens){return err?callback&&callback(err,{interactive:interactive}):void LicensingUtils.getAuthorizationCode({redirect_uri:chrome.identity.getRedirectURL(),client_id:clientID,refresh_token:tokens.refresh_token,grant_type:"refresh_token"},function(err,newTokens){return debug.log("refreshToken() >> ",err,newTokens),err?(debug.error(err),LicensingUtils.storeOAuthTokens(null),callback&&callback(err,{interactive:interactive})):(newTokens.refresh_token=tokens.refresh_token,LicensingUtils.storeOAuthTokens(newTokens),callback&&callback(null,newTokens))})})},handleOAuthWebFlow:function(interactive,callback){interactive=interactive||!1,debug.log("Initiating Google OAuth process...");var calledRefreshToken=!1,authenticationCompleted=function(err,profileInfo,statusCode){return debug.log("authenticationCompleted()",err,profileInfo,statusCode),err&&401===statusCode&&!calledRefreshToken?(calledRefreshToken=!0,LicensingUtils.refreshToken(interactive,function(err,tokens){return debug.log("refreshToken() result: ",err,tokens),err?callback&&callback(err,{interactive:interactive}):LicensingUtils.getGoogleUserInfo(tokens.access_token,authenticationCompleted)})):err?(debug.error(err),callback&&callback(err,{interactive:interactive})):(profileInfo.interactive=interactive,callback&&callback(null,profileInfo))};return LicensingUtils.getOAuthTokens(function(err,tokens){if(err)return callback&&callback(err,{interactive:interactive});if(debug.log("tokens",tokens),interactive){var startUrl=LicensingUtils.createWebAuthFlowUrl();debug.log("OAuth start URL: "+startUrl);var oauthCallback=function(authUrl){if(chrome.runtime.lastError)return debug.error(chrome.runtime.lastError),callback&&callback(chrome.runtime.lastError,{interactive:interactive});var urlParts=LicensingUtils.parseWebFlowUrl(authUrl);debug.log("authUrl",authUrl,urlParts);var clientID=$C.OAuthSettings.ClientId;clientID.indexOf("@@")>=0&&(clientID=$C.OAuthSettings.ClientId_DEV),LicensingUtils.getAuthorizationCode({redirect_uri:chrome.identity.getRedirectURL(),client_id:clientID,code:urlParts.queryParams.code,grant_type:"authorization_code"},function(err,tokens){return debug.log("getAuthorizationCode() >> ",err,tokens),err?(debug.error(err),callback&&callback(err,{interactive:interactive})):(LicensingUtils.storeOAuthTokens(tokens),LicensingUtils.getGoogleUserInfo(tokens.access_token,authenticationCompleted))})};return chrome.identity.launchWebAuthFlow({url:startUrl,interactive:interactive},oauthCallback)}return!interactive&&tokens.access_token?(debug.log("Access token found on storage..."),LicensingUtils.getGoogleUserInfo(tokens.access_token,authenticationCompleted)):(debug.log("Required user authentication..."),callback&&callback(new Error("Required interactive user authentication to proceed"),{interactive:interactive}))})},getGoogleUserInfo:function(accessToken,callback){var profileEndpoint=$C.Endpoints.GoogleProfileUrl+accessToken;$.ajax({type:"GET",cache:!1,url:profileEndpoint,cache:!1,headers:null,success:function(data,textStatus,response){return debug.log("getGoogleUserInfo: success(): ",response.status,data),callback&&callback(null,data,response.status)},error:function(response,textStatus,errorThrown){return console.log("getGoogleUserInfo: error(): ",response.status,textStatus,errorThrown),response&&response.responseText?callback&&callback(new Error("Unexpected error: "+response.responseText+" "+response.status),null,response.status):callback&&callback(new Error("Unexpected error: "+errorThrown+" "+textStatus),null,response.status)}})},clearCachedTokens:function(callback){return LicensingUtils.getOAuthTokens(function(err,tokens){if(err)return debug.error(err),callback&&callback(err);LicensingUtils.storeOAuthTokens(null);var revokeTokenEndpoint=$C.Endpoints.GoogleRevokeTokenUrl+tokens.refresh_token;return $.ajax({type:"POST",cache:!1,url:revokeTokenEndpoint,cache:!1,headers:{"content-type":"application/x-www-form-urlencoded"},success:function(data,textStatus,request){return callback&&callback()},error:function(response,textStatus,errorThrown){return response&&response.responseText?callback&&callback(new Error("Unexpected error: "+response.responseText+" "+response.status)):callback&&callback(new Error("Unexpected error: "+errorThrown+" "+textStatus))}})})},getOAuthTokens:function(callback){return PopupUtils.getConfigParameterLocal(PopupUtils.StorageParamNameCustomAuthFlowTokens,function(err,params){if(err)return callback&&callback(err);var tokens=(params||{})[PopupUtils.StorageParamNameCustomAuthFlowTokens]||null;if(!tokens)return callback&&callback(null,{});try{return tokens=JSON.parse(PopupUtils.deobfuscate(tokens)),callback&&callback(null,tokens)}catch(ex){return console.error("Error deobfuscating tokens",ex),callback&&callback(null,{})}})},storeOAuthTokens:function(tokens,callback){var tokens=PopupUtils.obfuscate(JSON.stringify(tokens||{}));return PopupUtils.setConfigParameterLocal(PopupUtils.StorageParamNameCustomAuthFlowTokens,tokens,function(err){return callback&&callback(err)})}};return LicensingUtils}),global.true=exports}({},function(){return this}());